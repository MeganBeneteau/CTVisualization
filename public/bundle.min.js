'use strict';

/* App Module */

var ctApp = angular.module('ctApp', [
  'ngRoute',
  'ctMain',
]);

ctApp.config(['$routeProvider',
  function($routeProvider) {
    $routeProvider.
      when('/', {
        templateUrl: 'components/Main/main.html',
        controller: 'MainController'
      }).
      otherwise({
        redirectTo: '/'
      });
  }]);


var container;

var camera, scene, renderer;
var cameraCube, sceneCube;

var mesh, lightMesh, geometry;
var spheres = [];

var directionalLight, pointLight;

var mouseX = 0;
var mouseY = 0;

var rx = 5000;
var ry = 5000;

var windowHalfX = 640 / 2;
var windowHalfY = 480 / 2;


function init() {

  container = $('#main');

  camera = new THREE.PerspectiveCamera( 60, 640/480, 1, 100000 );
  camera.position.z = 3200;

  cameraCube = new THREE.PerspectiveCamera( 60, 640/480, 1, 100000 );

  scene = new THREE.Scene();
  sceneCube = new THREE.Scene();

  var geometry = new THREE.SphereBufferGeometry( 100, 32, 16 );

  var path = "assets/images/pisa/";
  var format = '.png';
  var urls = [
    path + 'px' + format, path + 'nx' + format,
    path + 'py' + format, path + 'ny' + format,
    path + 'pz' + format, path + 'nz' + format
  ];

  var textureCube = new THREE.CubeTextureLoader().load( urls );
  var material = new THREE.MeshBasicMaterial( { color: 0xffffff, envMap: textureCube } );

  for ( var i = 0; i < 500; i ++ ) {

    var mesh = new THREE.Mesh( geometry, material );

    mesh.position.x = Math.random() * 10000 - 5000;
    mesh.position.y = Math.random() * 10000 - 5000;
    mesh.position.z = Math.random() * 10000 - 5000;

    mesh.scale.x = mesh.scale.y = mesh.scale.z = Math.random() * 3 + 1;

    scene.add( mesh );

    spheres.push( mesh );

  }

  // Skybox

  var shader = THREE.ShaderLib[ "cube" ];
  shader.uniforms[ "tCube" ].value = textureCube;

  var material = new THREE.ShaderMaterial( {

    fragmentShader: shader.fragmentShader,
    vertexShader: shader.vertexShader,
    uniforms: shader.uniforms,
    depthWrite: false,
    side: THREE.BackSide

  } ),

  mesh = new THREE.Mesh( new THREE.BoxGeometry( 100, 100, 100 ), material );
  sceneCube.add( mesh );

  //

  renderer = new THREE.WebGLRenderer();
  renderer.setPixelRatio( window.devicePixelRatio );
  renderer.setSize( 640, 480 );
  renderer.autoClear = false;
  renderer.domElement.setAttribute('id', 'canvas');
  container.append( renderer.domElement );

  //

  window.addEventListener( 'resize', onWindowResize, false );

}

function onWindowResize() {

  windowHalfX = 640 / 2;
  windowHalfY = 480 / 2;

  camera.aspect = 640/480;
  camera.updateProjectionMatrix();

  cameraCube.aspect = 640/480;
  cameraCube.updateProjectionMatrix();


  renderer.setSize( 640, 480 );

}

function onDocumentMouseMove( event ) {

  mouseX = ( event.clientX - 640 ) * 10;
  mouseY = ( event.clientY - 480 ) * 10;

}

function animate() {

  requestAnimationFrame( animate );

  render();

}

function render() {

  var timer = 0.0001 * Date.now();

  for ( var i = 0, il = spheres.length; i < il; i ++ ) {

    var sphere = spheres[ i ];

    sphere.position.x = rx * Math.cos( timer + i );
    sphere.position.y = ry * Math.sin( timer + i * 1.1 );

  }

  camera.position.x += ( mouseX - camera.position.x ) * 0.05;
  camera.position.y += ( - mouseY - camera.position.y ) * 0.05;

  camera.lookAt( scene.position );
  cameraCube.rotation.copy( camera.rotation );

  renderer.render( sceneCube, cameraCube );
  renderer.render( scene, camera );

}


$(document).on('readyForCanvas', function(event) {
  console.log("readyForCanvas");
  init();
  animate();
  $("#canvas").on( 'mousemove', onDocumentMouseMove );
});

$(document).on('rotationValueChanged', function(event, x, y) {
  console.log('rotationValueChanged: ' + x + ', ' + y);
  rx = x;
  ry = y;
});


var container;

var camera, sceneFirstPass, sceneSecondPass, renderer;
var rtTexture;
var cubeTexture;
var transferTexture;

var materialFirstPass, materialSecondPass;

var mesh, geometry;
var spheres = [];

var vertexShader1, fragmentShader1;
var vertexShader2, fragmentShader2;

var screenSize = {x: 640, y: 480};
var windowHalfX = screenSize.x / 2;
var windowHalfY = screenSize.y / 2;

function loadResource(url, callback) {
  $.ajax({
    url: url,
    success: function(data) {
      return callback(null, data);
    },
    error: function(err) {
      return callback(err, null);
    }
  });
}

// Load shaders
function loadShaders() {
  console.log("HELLO");
  loadResource('/assets/shaders/raycaster.firstpass.vs', function(err, data) {
    if(err) {
      console.log(err);
    }
    vertexShader1 = data;

    loadResource('/assets/shaders/raycaster.firstpass.fs', function(err, data) {
      if(err) {
        console.log(err);
      }
      fragmentShader1 = data;

      loadResource('/assets/shaders/raycaster.secondpass.vs', function(err, data) {
        if(err) {
          console.log(err);
        }
        vertexShader2 = data;

        loadResource('/assets/shaders/raycaster.secondpass.fs', function(err, data) {
          if(err) {
            console.log(err);
          }
          fragmentShader2 = data;
          init();
        });
      });
    });
  });
}


function init() {

  container = $('#main');

  camera = new THREE.PerspectiveCamera( 60, screenSize.x/screenSize.y, 0.1, 100000 );
  camera.position.z = 2;

  sceneFirstPass = new THREE.Scene();
	sceneSecondPass = new THREE.Scene();

  cubeTexture = THREE.ImageUtils.loadTexture('/assets/images/bonsai.raw.png' );
  cubeTexture.generateMipmaps = false;
  cubeTexture.minFilter = THREE.LinearFilter;
  cubeTexture.magFilter = THREE.LinearFilter;

  transferTexture = updateTransferFunction();

  rtTexture = new THREE.WebGLRenderTarget( screenSize.x, screenSize.y,
														{ 	minFilter: THREE.LinearFilter,
															magFilter: THREE.LinearFilter,
															wrapS:  THREE.ClampToEdgeWrapping,
															wrapT:  THREE.ClampToEdgeWrapping,
															format: THREE.RGBFormat,
															type: THREE.FloatType,
															generateMipmaps: false} );


  materialFirstPass = new THREE.ShaderMaterial( {
  	vertexShader: vertexShader1,
  	fragmentShader: fragmentShader1,
  	side: THREE.BackSide
  } );

	materialSecondPass = new THREE.ShaderMaterial( {
  	vertexShader: vertexShader2,
  	fragmentShader: fragmentShader2,
		side: THREE.FrontSide,
		uniforms: {
      tex:  {
        type: "t",
        value: rtTexture
      },
			cubeTex:
      {
        type: "t",
        value: cubeTexture
      },
			transferTex:
      {
        type: "t",
        value: transferTexture
      },
			steps : {
        type: "1f" ,
        value: 256
      },
			alphaCorrection : {
        type: "1f" ,
        value: 1.0
      }
    }
	 });


  // Geometry setup
	var boxGeometry = new THREE.BoxGeometry(1.0, 1.0, 1.0);
	boxGeometry.doubleSided = true;
	var meshFirstPass = new THREE.Mesh( boxGeometry, materialFirstPass );
	var meshSecondPass = new THREE.Mesh( boxGeometry, materialSecondPass );
	sceneFirstPass.add( meshFirstPass );
	sceneSecondPass.add( meshSecondPass );


  renderer = new THREE.WebGLRenderer();
  renderer.setPixelRatio( window.devicePixelRatio );
  renderer.setSize( screenSize.x, screenSize.y );
  renderer.autoClear = true;
  renderer.setClearColor("#FFFFFF");
  console.log("clear color: ");
  console.log(renderer.getClearColor());
  renderer.domElement.setAttribute('id', 'canvas');
  container.append( renderer.domElement );

  var b = new THREE.BoxGeometry(2,2,2);
  var bmat = new THREE.MeshBasicMaterial({color: "#FF0000"});

  var bmesh = new THREE.Mesh(b, bmat);
  bmesh.position.x = 0;
  bmesh.position.y = 0;
  bmesh.position.z = 0;

  //sceneSecondPass.add(bmesh);

  window.addEventListener( 'resize', onWindowResize, false );

  animate();
}

function onWindowResize() {

  windowHalfX = screenSize.x / 2;
  windowHalfY = screenSize.y / 2;

  camera.aspect = screenSize.x/screenSize.y;
  camera.updateProjectionMatrix();

  renderer.setSize( screenSize.x, screenSize.y );

}


function animate() {

  requestAnimationFrame( animate );

  render();

}

function render() {

  //var delta = clock.getDelta();
	//Render first pass and store the world space coords of the back face fragments into the texture.
	renderer.render( sceneFirstPass, camera, rtTexture, true );
	//Render the second pass and perform the volume rendering.
	renderer.render( sceneSecondPass, camera );
	materialSecondPass.uniforms.steps.value = 256;
	materialSecondPass.uniforms.alphaCorrection.value = 1.0;

}

function updateTextures(value) {
  materialSecondPass.uniforms.transferTex.value = updateTransferFunction();
}

function updateTransferFunction() {
	var canvas = document.createElement('canvas');
	canvas.height = 20;
	canvas.width = 256;
	var ctx = canvas.getContext('2d');
	var grd = ctx.createLinearGradient(0, 0, canvas.width -1 , canvas.height - 1);
	grd.addColorStop(0.1, "#00FF00");
	grd.addColorStop(0.7, "#FF0000");
	grd.addColorStop(1.0, "#0000FF");
	ctx.fillStyle = grd;
	ctx.fillRect(0,0,canvas.width -1 ,canvas.height -1 );

  var img = document.getElementById("transferTexture");
				img.src = canvas.toDataURL();
				img.style.width = "256 px";
				img.style.height = "128 px";

	transferTexture =  new THREE.Texture(canvas);
	transferTexture.wrapS = transferTexture.wrapT =  THREE.ClampToEdgeWrapping;
	transferTexture.needsUpdate = true;
	return transferTexture;
}


$(document).on('readyForCanvasRaycaster', function(event) {
  console.log("readyForCanvasRaycaster");
  loadShaders();
  $("#canvas").on( 'mousemove', onDocumentMouseMove );
});

$(document).on('rotationValueChanged', function(event, x, y) {
  console.log('rotationValueChanged: ' + x + ', ' + y);
  rx = x;
  ry = y;
});


'use strict';

var main = angular.module('ctMain', []);

main.controller('MainController', ['$scope', function($scope) {
  $(document).trigger('readyForCanvasRaycaster');

  $scope.updateRotation = function() {
    console.log("onClickRotationChanged");
    $(document).trigger('rotationValueChanged', [parseInt($scope.rotation.x), parseInt($scope.rotation.y)]);
  };
}]);


//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsInRocmVlanMvZXhhbXBsZS5qcyIsInRocmVlanMvcmF5Y2FzdGVyLmpzIiwiY29tcG9uZW50cy9NYWluL21haW5Db250cm9sbGVyLmpzIiwiY29tcG9uZW50cy9UaHJlZVZpZXdlckNvbXBvbmVudC92aWV3ZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFJQSxJQUFBLFFBQUEsUUFBQSxPQUFBLFNBQUE7RUFDQTtFQUNBOzs7QUFHQSxNQUFBLE9BQUEsQ0FBQTtFQUNBLFNBQUEsZ0JBQUE7SUFDQTtNQUNBLEtBQUEsS0FBQTtRQUNBLGFBQUE7UUFDQSxZQUFBOztNQUVBLFVBQUE7UUFDQSxZQUFBOzs7OztBQ2hCQSxJQUFBOztBQUVBLElBQUEsUUFBQSxPQUFBO0FBQ0EsSUFBQSxZQUFBOztBQUVBLElBQUEsTUFBQSxXQUFBO0FBQ0EsSUFBQSxVQUFBOztBQUVBLElBQUEsa0JBQUE7O0FBRUEsSUFBQSxTQUFBO0FBQ0EsSUFBQSxTQUFBOztBQUVBLElBQUEsS0FBQTtBQUNBLElBQUEsS0FBQTs7QUFFQSxJQUFBLGNBQUEsTUFBQTtBQUNBLElBQUEsY0FBQSxNQUFBOzs7QUFHQSxTQUFBLE9BQUE7O0VBRUEsWUFBQSxFQUFBOztFQUVBLFNBQUEsSUFBQSxNQUFBLG1CQUFBLElBQUEsSUFBQSxLQUFBLEdBQUE7RUFDQSxPQUFBLFNBQUEsSUFBQTs7RUFFQSxhQUFBLElBQUEsTUFBQSxtQkFBQSxJQUFBLElBQUEsS0FBQSxHQUFBOztFQUVBLFFBQUEsSUFBQSxNQUFBO0VBQ0EsWUFBQSxJQUFBLE1BQUE7O0VBRUEsSUFBQSxXQUFBLElBQUEsTUFBQSxzQkFBQSxLQUFBLElBQUE7O0VBRUEsSUFBQSxPQUFBO0VBQ0EsSUFBQSxTQUFBO0VBQ0EsSUFBQSxPQUFBO0lBQ0EsT0FBQSxPQUFBLFFBQUEsT0FBQSxPQUFBO0lBQ0EsT0FBQSxPQUFBLFFBQUEsT0FBQSxPQUFBO0lBQ0EsT0FBQSxPQUFBLFFBQUEsT0FBQSxPQUFBOzs7RUFHQSxJQUFBLGNBQUEsSUFBQSxNQUFBLG9CQUFBLE1BQUE7RUFDQSxJQUFBLFdBQUEsSUFBQSxNQUFBLG1CQUFBLEVBQUEsT0FBQSxVQUFBLFFBQUE7O0VBRUEsTUFBQSxJQUFBLElBQUEsR0FBQSxJQUFBLEtBQUEsT0FBQTs7SUFFQSxJQUFBLE9BQUEsSUFBQSxNQUFBLE1BQUEsVUFBQTs7SUFFQSxLQUFBLFNBQUEsSUFBQSxLQUFBLFdBQUEsUUFBQTtJQUNBLEtBQUEsU0FBQSxJQUFBLEtBQUEsV0FBQSxRQUFBO0lBQ0EsS0FBQSxTQUFBLElBQUEsS0FBQSxXQUFBLFFBQUE7O0lBRUEsS0FBQSxNQUFBLElBQUEsS0FBQSxNQUFBLElBQUEsS0FBQSxNQUFBLElBQUEsS0FBQSxXQUFBLElBQUE7O0lBRUEsTUFBQSxLQUFBOztJQUVBLFFBQUEsTUFBQTs7Ozs7O0VBTUEsSUFBQSxTQUFBLE1BQUEsV0FBQTtFQUNBLE9BQUEsVUFBQSxVQUFBLFFBQUE7O0VBRUEsSUFBQSxXQUFBLElBQUEsTUFBQSxnQkFBQTs7SUFFQSxnQkFBQSxPQUFBO0lBQ0EsY0FBQSxPQUFBO0lBQ0EsVUFBQSxPQUFBO0lBQ0EsWUFBQTtJQUNBLE1BQUEsTUFBQTs7OztFQUlBLE9BQUEsSUFBQSxNQUFBLE1BQUEsSUFBQSxNQUFBLGFBQUEsS0FBQSxLQUFBLE9BQUE7RUFDQSxVQUFBLEtBQUE7Ozs7RUFJQSxXQUFBLElBQUEsTUFBQTtFQUNBLFNBQUEsZUFBQSxPQUFBO0VBQ0EsU0FBQSxTQUFBLEtBQUE7RUFDQSxTQUFBLFlBQUE7RUFDQSxTQUFBLFdBQUEsYUFBQSxNQUFBO0VBQ0EsVUFBQSxRQUFBLFNBQUE7Ozs7RUFJQSxPQUFBLGtCQUFBLFVBQUEsZ0JBQUE7Ozs7QUFJQSxTQUFBLGlCQUFBOztFQUVBLGNBQUEsTUFBQTtFQUNBLGNBQUEsTUFBQTs7RUFFQSxPQUFBLFNBQUEsSUFBQTtFQUNBLE9BQUE7O0VBRUEsV0FBQSxTQUFBLElBQUE7RUFDQSxXQUFBOzs7RUFHQSxTQUFBLFNBQUEsS0FBQTs7OztBQUlBLFNBQUEscUJBQUEsUUFBQTs7RUFFQSxTQUFBLEVBQUEsTUFBQSxVQUFBLFFBQUE7RUFDQSxTQUFBLEVBQUEsTUFBQSxVQUFBLFFBQUE7Ozs7QUFJQSxTQUFBLFVBQUE7O0VBRUEsdUJBQUE7O0VBRUE7Ozs7QUFJQSxTQUFBLFNBQUE7O0VBRUEsSUFBQSxRQUFBLFNBQUEsS0FBQTs7RUFFQSxNQUFBLElBQUEsSUFBQSxHQUFBLEtBQUEsUUFBQSxRQUFBLElBQUEsSUFBQSxPQUFBOztJQUVBLElBQUEsU0FBQSxTQUFBOztJQUVBLE9BQUEsU0FBQSxJQUFBLEtBQUEsS0FBQSxLQUFBLFFBQUE7SUFDQSxPQUFBLFNBQUEsSUFBQSxLQUFBLEtBQUEsS0FBQSxRQUFBLElBQUE7Ozs7RUFJQSxPQUFBLFNBQUEsS0FBQSxFQUFBLFNBQUEsT0FBQSxTQUFBLE1BQUE7RUFDQSxPQUFBLFNBQUEsS0FBQSxFQUFBLEVBQUEsU0FBQSxPQUFBLFNBQUEsTUFBQTs7RUFFQSxPQUFBLFFBQUEsTUFBQTtFQUNBLFdBQUEsU0FBQSxNQUFBLE9BQUE7O0VBRUEsU0FBQSxRQUFBLFdBQUE7RUFDQSxTQUFBLFFBQUEsT0FBQTs7Ozs7QUFLQSxFQUFBLFVBQUEsR0FBQSxrQkFBQSxTQUFBLE9BQUE7RUFDQSxRQUFBLElBQUE7RUFDQTtFQUNBO0VBQ0EsRUFBQSxXQUFBLElBQUEsYUFBQTs7O0FBR0EsRUFBQSxVQUFBLEdBQUEsd0JBQUEsU0FBQSxPQUFBLEdBQUEsR0FBQTtFQUNBLFFBQUEsSUFBQSwyQkFBQSxJQUFBLE9BQUE7RUFDQSxLQUFBO0VBQ0EsS0FBQTs7OztBQ2hLQSxJQUFBOztBQUVBLElBQUEsUUFBQSxnQkFBQSxpQkFBQTtBQUNBLElBQUE7QUFDQSxJQUFBO0FBQ0EsSUFBQTs7QUFFQSxJQUFBLG1CQUFBOztBQUVBLElBQUEsTUFBQTtBQUNBLElBQUEsVUFBQTs7QUFFQSxJQUFBLGVBQUE7QUFDQSxJQUFBLGVBQUE7O0FBRUEsSUFBQSxhQUFBLENBQUEsR0FBQSxLQUFBLEdBQUE7QUFDQSxJQUFBLGNBQUEsV0FBQSxJQUFBO0FBQ0EsSUFBQSxjQUFBLFdBQUEsSUFBQTs7QUFFQSxTQUFBLGFBQUEsS0FBQSxVQUFBO0VBQ0EsRUFBQSxLQUFBO0lBQ0EsS0FBQTtJQUNBLFNBQUEsU0FBQSxNQUFBO01BQ0EsT0FBQSxTQUFBLE1BQUE7O0lBRUEsT0FBQSxTQUFBLEtBQUE7TUFDQSxPQUFBLFNBQUEsS0FBQTs7Ozs7O0FBTUEsU0FBQSxjQUFBO0VBQ0EsUUFBQSxJQUFBO0VBQ0EsYUFBQSwwQ0FBQSxTQUFBLEtBQUEsTUFBQTtJQUNBLEdBQUEsS0FBQTtNQUNBLFFBQUEsSUFBQTs7SUFFQSxnQkFBQTs7SUFFQSxhQUFBLDBDQUFBLFNBQUEsS0FBQSxNQUFBO01BQ0EsR0FBQSxLQUFBO1FBQ0EsUUFBQSxJQUFBOztNQUVBLGtCQUFBOztNQUVBLGFBQUEsMkNBQUEsU0FBQSxLQUFBLE1BQUE7UUFDQSxHQUFBLEtBQUE7VUFDQSxRQUFBLElBQUE7O1FBRUEsZ0JBQUE7O1FBRUEsYUFBQSwyQ0FBQSxTQUFBLEtBQUEsTUFBQTtVQUNBLEdBQUEsS0FBQTtZQUNBLFFBQUEsSUFBQTs7VUFFQSxrQkFBQTtVQUNBOzs7Ozs7OztBQVFBLFNBQUEsT0FBQTs7RUFFQSxZQUFBLEVBQUE7O0VBRUEsU0FBQSxJQUFBLE1BQUEsbUJBQUEsSUFBQSxXQUFBLEVBQUEsV0FBQSxHQUFBLEtBQUE7RUFDQSxPQUFBLFNBQUEsSUFBQTs7RUFFQSxpQkFBQSxJQUFBLE1BQUE7Q0FDQSxrQkFBQSxJQUFBLE1BQUE7O0VBRUEsY0FBQSxNQUFBLFdBQUEsWUFBQTtFQUNBLFlBQUEsa0JBQUE7RUFDQSxZQUFBLFlBQUEsTUFBQTtFQUNBLFlBQUEsWUFBQSxNQUFBOztFQUVBLGtCQUFBOztFQUVBLFlBQUEsSUFBQSxNQUFBLG1CQUFBLFdBQUEsR0FBQSxXQUFBO2NBQ0EsR0FBQSxXQUFBLE1BQUE7ZUFDQSxXQUFBLE1BQUE7ZUFDQSxRQUFBLE1BQUE7ZUFDQSxRQUFBLE1BQUE7ZUFDQSxRQUFBLE1BQUE7ZUFDQSxNQUFBLE1BQUE7ZUFDQSxpQkFBQTs7O0VBR0Esb0JBQUEsSUFBQSxNQUFBLGdCQUFBO0dBQ0EsY0FBQTtHQUNBLGdCQUFBO0dBQ0EsTUFBQSxNQUFBOzs7Q0FHQSxxQkFBQSxJQUFBLE1BQUEsZ0JBQUE7R0FDQSxjQUFBO0dBQ0EsZ0JBQUE7RUFDQSxNQUFBLE1BQUE7RUFDQSxVQUFBO01BQ0EsTUFBQTtRQUNBLE1BQUE7UUFDQSxPQUFBOztHQUVBO01BQ0E7UUFDQSxNQUFBO1FBQ0EsT0FBQTs7R0FFQTtNQUNBO1FBQ0EsTUFBQTtRQUNBLE9BQUE7O0dBRUEsUUFBQTtRQUNBLE1BQUE7UUFDQSxPQUFBOztHQUVBLGtCQUFBO1FBQ0EsTUFBQTtRQUNBLE9BQUE7Ozs7Ozs7Q0FPQSxJQUFBLGNBQUEsSUFBQSxNQUFBLFlBQUEsS0FBQSxLQUFBO0NBQ0EsWUFBQSxjQUFBO0NBQ0EsSUFBQSxnQkFBQSxJQUFBLE1BQUEsTUFBQSxhQUFBO0NBQ0EsSUFBQSxpQkFBQSxJQUFBLE1BQUEsTUFBQSxhQUFBO0NBQ0EsZUFBQSxLQUFBO0NBQ0EsZ0JBQUEsS0FBQTs7O0VBR0EsV0FBQSxJQUFBLE1BQUE7RUFDQSxTQUFBLGVBQUEsT0FBQTtFQUNBLFNBQUEsU0FBQSxXQUFBLEdBQUEsV0FBQTtFQUNBLFNBQUEsWUFBQTtFQUNBLFNBQUEsY0FBQTtFQUNBLFFBQUEsSUFBQTtFQUNBLFFBQUEsSUFBQSxTQUFBO0VBQ0EsU0FBQSxXQUFBLGFBQUEsTUFBQTtFQUNBLFVBQUEsUUFBQSxTQUFBOztFQUVBLElBQUEsSUFBQSxJQUFBLE1BQUEsWUFBQSxFQUFBLEVBQUE7RUFDQSxJQUFBLE9BQUEsSUFBQSxNQUFBLGtCQUFBLENBQUEsT0FBQTs7RUFFQSxJQUFBLFFBQUEsSUFBQSxNQUFBLEtBQUEsR0FBQTtFQUNBLE1BQUEsU0FBQSxJQUFBO0VBQ0EsTUFBQSxTQUFBLElBQUE7RUFDQSxNQUFBLFNBQUEsSUFBQTs7OztFQUlBLE9BQUEsa0JBQUEsVUFBQSxnQkFBQTs7RUFFQTs7O0FBR0EsU0FBQSxpQkFBQTs7RUFFQSxjQUFBLFdBQUEsSUFBQTtFQUNBLGNBQUEsV0FBQSxJQUFBOztFQUVBLE9BQUEsU0FBQSxXQUFBLEVBQUEsV0FBQTtFQUNBLE9BQUE7O0VBRUEsU0FBQSxTQUFBLFdBQUEsR0FBQSxXQUFBOzs7OztBQUtBLFNBQUEsVUFBQTs7RUFFQSx1QkFBQTs7RUFFQTs7OztBQUlBLFNBQUEsU0FBQTs7OztDQUlBLFNBQUEsUUFBQSxnQkFBQSxRQUFBLFdBQUE7O0NBRUEsU0FBQSxRQUFBLGlCQUFBO0NBQ0EsbUJBQUEsU0FBQSxNQUFBLFFBQUE7Q0FDQSxtQkFBQSxTQUFBLGdCQUFBLFFBQUE7Ozs7QUFJQSxTQUFBLGVBQUEsT0FBQTtFQUNBLG1CQUFBLFNBQUEsWUFBQSxRQUFBOzs7QUFHQSxTQUFBLHlCQUFBO0NBQ0EsSUFBQSxTQUFBLFNBQUEsY0FBQTtDQUNBLE9BQUEsU0FBQTtDQUNBLE9BQUEsUUFBQTtDQUNBLElBQUEsTUFBQSxPQUFBLFdBQUE7Q0FDQSxJQUFBLE1BQUEsSUFBQSxxQkFBQSxHQUFBLEdBQUEsT0FBQSxPQUFBLElBQUEsT0FBQSxTQUFBO0NBQ0EsSUFBQSxhQUFBLEtBQUE7Q0FDQSxJQUFBLGFBQUEsS0FBQTtDQUNBLElBQUEsYUFBQSxLQUFBO0NBQ0EsSUFBQSxZQUFBO0NBQ0EsSUFBQSxTQUFBLEVBQUEsRUFBQSxPQUFBLE9BQUEsR0FBQSxPQUFBLFFBQUE7O0VBRUEsSUFBQSxNQUFBLFNBQUEsZUFBQTtJQUNBLElBQUEsTUFBQSxPQUFBO0lBQ0EsSUFBQSxNQUFBLFFBQUE7SUFDQSxJQUFBLE1BQUEsU0FBQTs7Q0FFQSxtQkFBQSxJQUFBLE1BQUEsUUFBQTtDQUNBLGdCQUFBLFFBQUEsZ0JBQUEsU0FBQSxNQUFBO0NBQ0EsZ0JBQUEsY0FBQTtDQUNBLE9BQUE7Ozs7QUFJQSxFQUFBLFVBQUEsR0FBQSwyQkFBQSxTQUFBLE9BQUE7RUFDQSxRQUFBLElBQUE7RUFDQTtFQUNBLEVBQUEsV0FBQSxJQUFBLGFBQUE7OztBQUdBLEVBQUEsVUFBQSxHQUFBLHdCQUFBLFNBQUEsT0FBQSxHQUFBLEdBQUE7RUFDQSxRQUFBLElBQUEsMkJBQUEsSUFBQSxPQUFBO0VBQ0EsS0FBQTtFQUNBLEtBQUE7Ozs7QUN6T0E7O0FBRUEsSUFBQSxPQUFBLFFBQUEsT0FBQSxVQUFBOztBQUVBLEtBQUEsV0FBQSxrQkFBQSxDQUFBLFVBQUEsU0FBQSxRQUFBO0VBQ0EsRUFBQSxVQUFBLFFBQUE7O0VBRUEsT0FBQSxpQkFBQSxXQUFBO0lBQ0EsUUFBQSxJQUFBO0lBQ0EsRUFBQSxVQUFBLFFBQUEsd0JBQUEsQ0FBQSxTQUFBLE9BQUEsU0FBQSxJQUFBLFNBQUEsT0FBQSxTQUFBOzs7O0FDVkEiLCJmaWxlIjoiYnVuZGxlLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuLyogQXBwIE1vZHVsZSAqL1xuXG52YXIgY3RBcHAgPSBhbmd1bGFyLm1vZHVsZSgnY3RBcHAnLCBbXG4gICduZ1JvdXRlJyxcbiAgJ2N0TWFpbicsXG5dKTtcblxuY3RBcHAuY29uZmlnKFsnJHJvdXRlUHJvdmlkZXInLFxuICBmdW5jdGlvbigkcm91dGVQcm92aWRlcikge1xuICAgICRyb3V0ZVByb3ZpZGVyLlxuICAgICAgd2hlbignLycsIHtcbiAgICAgICAgdGVtcGxhdGVVcmw6ICdjb21wb25lbnRzL01haW4vbWFpbi5odG1sJyxcbiAgICAgICAgY29udHJvbGxlcjogJ01haW5Db250cm9sbGVyJ1xuICAgICAgfSkuXG4gICAgICBvdGhlcndpc2Uoe1xuICAgICAgICByZWRpcmVjdFRvOiAnLydcbiAgICAgIH0pO1xuICB9XSk7XG4iLCJcbnZhciBjb250YWluZXI7XG5cbnZhciBjYW1lcmEsIHNjZW5lLCByZW5kZXJlcjtcbnZhciBjYW1lcmFDdWJlLCBzY2VuZUN1YmU7XG5cbnZhciBtZXNoLCBsaWdodE1lc2gsIGdlb21ldHJ5O1xudmFyIHNwaGVyZXMgPSBbXTtcblxudmFyIGRpcmVjdGlvbmFsTGlnaHQsIHBvaW50TGlnaHQ7XG5cbnZhciBtb3VzZVggPSAwO1xudmFyIG1vdXNlWSA9IDA7XG5cbnZhciByeCA9IDUwMDA7XG52YXIgcnkgPSA1MDAwO1xuXG52YXIgd2luZG93SGFsZlggPSA2NDAgLyAyO1xudmFyIHdpbmRvd0hhbGZZID0gNDgwIC8gMjtcblxuXG5mdW5jdGlvbiBpbml0KCkge1xuXG4gIGNvbnRhaW5lciA9ICQoJyNtYWluJyk7XG5cbiAgY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKCA2MCwgNjQwLzQ4MCwgMSwgMTAwMDAwICk7XG4gIGNhbWVyYS5wb3NpdGlvbi56ID0gMzIwMDtcblxuICBjYW1lcmFDdWJlID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKCA2MCwgNjQwLzQ4MCwgMSwgMTAwMDAwICk7XG5cbiAgc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTtcbiAgc2NlbmVDdWJlID0gbmV3IFRIUkVFLlNjZW5lKCk7XG5cbiAgdmFyIGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUJ1ZmZlckdlb21ldHJ5KCAxMDAsIDMyLCAxNiApO1xuXG4gIHZhciBwYXRoID0gXCJhc3NldHMvaW1hZ2VzL3Bpc2EvXCI7XG4gIHZhciBmb3JtYXQgPSAnLnBuZyc7XG4gIHZhciB1cmxzID0gW1xuICAgIHBhdGggKyAncHgnICsgZm9ybWF0LCBwYXRoICsgJ254JyArIGZvcm1hdCxcbiAgICBwYXRoICsgJ3B5JyArIGZvcm1hdCwgcGF0aCArICdueScgKyBmb3JtYXQsXG4gICAgcGF0aCArICdweicgKyBmb3JtYXQsIHBhdGggKyAnbnonICsgZm9ybWF0XG4gIF07XG5cbiAgdmFyIHRleHR1cmVDdWJlID0gbmV3IFRIUkVFLkN1YmVUZXh0dXJlTG9hZGVyKCkubG9hZCggdXJscyApO1xuICB2YXIgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoIHsgY29sb3I6IDB4ZmZmZmZmLCBlbnZNYXA6IHRleHR1cmVDdWJlIH0gKTtcblxuICBmb3IgKCB2YXIgaSA9IDA7IGkgPCA1MDA7IGkgKysgKSB7XG5cbiAgICB2YXIgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKCBnZW9tZXRyeSwgbWF0ZXJpYWwgKTtcblxuICAgIG1lc2gucG9zaXRpb24ueCA9IE1hdGgucmFuZG9tKCkgKiAxMDAwMCAtIDUwMDA7XG4gICAgbWVzaC5wb3NpdGlvbi55ID0gTWF0aC5yYW5kb20oKSAqIDEwMDAwIC0gNTAwMDtcbiAgICBtZXNoLnBvc2l0aW9uLnogPSBNYXRoLnJhbmRvbSgpICogMTAwMDAgLSA1MDAwO1xuXG4gICAgbWVzaC5zY2FsZS54ID0gbWVzaC5zY2FsZS55ID0gbWVzaC5zY2FsZS56ID0gTWF0aC5yYW5kb20oKSAqIDMgKyAxO1xuXG4gICAgc2NlbmUuYWRkKCBtZXNoICk7XG5cbiAgICBzcGhlcmVzLnB1c2goIG1lc2ggKTtcblxuICB9XG5cbiAgLy8gU2t5Ym94XG5cbiAgdmFyIHNoYWRlciA9IFRIUkVFLlNoYWRlckxpYlsgXCJjdWJlXCIgXTtcbiAgc2hhZGVyLnVuaWZvcm1zWyBcInRDdWJlXCIgXS52YWx1ZSA9IHRleHR1cmVDdWJlO1xuXG4gIHZhciBtYXRlcmlhbCA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCgge1xuXG4gICAgZnJhZ21lbnRTaGFkZXI6IHNoYWRlci5mcmFnbWVudFNoYWRlcixcbiAgICB2ZXJ0ZXhTaGFkZXI6IHNoYWRlci52ZXJ0ZXhTaGFkZXIsXG4gICAgdW5pZm9ybXM6IHNoYWRlci51bmlmb3JtcyxcbiAgICBkZXB0aFdyaXRlOiBmYWxzZSxcbiAgICBzaWRlOiBUSFJFRS5CYWNrU2lkZVxuXG4gIH0gKSxcblxuICBtZXNoID0gbmV3IFRIUkVFLk1lc2goIG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSggMTAwLCAxMDAsIDEwMCApLCBtYXRlcmlhbCApO1xuICBzY2VuZUN1YmUuYWRkKCBtZXNoICk7XG5cbiAgLy9cblxuICByZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKCk7XG4gIHJlbmRlcmVyLnNldFBpeGVsUmF0aW8oIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvICk7XG4gIHJlbmRlcmVyLnNldFNpemUoIDY0MCwgNDgwICk7XG4gIHJlbmRlcmVyLmF1dG9DbGVhciA9IGZhbHNlO1xuICByZW5kZXJlci5kb21FbGVtZW50LnNldEF0dHJpYnV0ZSgnaWQnLCAnY2FudmFzJyk7XG4gIGNvbnRhaW5lci5hcHBlbmQoIHJlbmRlcmVyLmRvbUVsZW1lbnQgKTtcblxuICAvL1xuXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAncmVzaXplJywgb25XaW5kb3dSZXNpemUsIGZhbHNlICk7XG5cbn1cblxuZnVuY3Rpb24gb25XaW5kb3dSZXNpemUoKSB7XG5cbiAgd2luZG93SGFsZlggPSA2NDAgLyAyO1xuICB3aW5kb3dIYWxmWSA9IDQ4MCAvIDI7XG5cbiAgY2FtZXJhLmFzcGVjdCA9IDY0MC80ODA7XG4gIGNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7XG5cbiAgY2FtZXJhQ3ViZS5hc3BlY3QgPSA2NDAvNDgwO1xuICBjYW1lcmFDdWJlLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTtcblxuXG4gIHJlbmRlcmVyLnNldFNpemUoIDY0MCwgNDgwICk7XG5cbn1cblxuZnVuY3Rpb24gb25Eb2N1bWVudE1vdXNlTW92ZSggZXZlbnQgKSB7XG5cbiAgbW91c2VYID0gKCBldmVudC5jbGllbnRYIC0gNjQwICkgKiAxMDtcbiAgbW91c2VZID0gKCBldmVudC5jbGllbnRZIC0gNDgwICkgKiAxMDtcblxufVxuXG5mdW5jdGlvbiBhbmltYXRlKCkge1xuXG4gIHJlcXVlc3RBbmltYXRpb25GcmFtZSggYW5pbWF0ZSApO1xuXG4gIHJlbmRlcigpO1xuXG59XG5cbmZ1bmN0aW9uIHJlbmRlcigpIHtcblxuICB2YXIgdGltZXIgPSAwLjAwMDEgKiBEYXRlLm5vdygpO1xuXG4gIGZvciAoIHZhciBpID0gMCwgaWwgPSBzcGhlcmVzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkge1xuXG4gICAgdmFyIHNwaGVyZSA9IHNwaGVyZXNbIGkgXTtcblxuICAgIHNwaGVyZS5wb3NpdGlvbi54ID0gcnggKiBNYXRoLmNvcyggdGltZXIgKyBpICk7XG4gICAgc3BoZXJlLnBvc2l0aW9uLnkgPSByeSAqIE1hdGguc2luKCB0aW1lciArIGkgKiAxLjEgKTtcblxuICB9XG5cbiAgY2FtZXJhLnBvc2l0aW9uLnggKz0gKCBtb3VzZVggLSBjYW1lcmEucG9zaXRpb24ueCApICogMC4wNTtcbiAgY2FtZXJhLnBvc2l0aW9uLnkgKz0gKCAtIG1vdXNlWSAtIGNhbWVyYS5wb3NpdGlvbi55ICkgKiAwLjA1O1xuXG4gIGNhbWVyYS5sb29rQXQoIHNjZW5lLnBvc2l0aW9uICk7XG4gIGNhbWVyYUN1YmUucm90YXRpb24uY29weSggY2FtZXJhLnJvdGF0aW9uICk7XG5cbiAgcmVuZGVyZXIucmVuZGVyKCBzY2VuZUN1YmUsIGNhbWVyYUN1YmUgKTtcbiAgcmVuZGVyZXIucmVuZGVyKCBzY2VuZSwgY2FtZXJhICk7XG5cbn1cblxuXG4kKGRvY3VtZW50KS5vbigncmVhZHlGb3JDYW52YXMnLCBmdW5jdGlvbihldmVudCkge1xuICBjb25zb2xlLmxvZyhcInJlYWR5Rm9yQ2FudmFzXCIpO1xuICBpbml0KCk7XG4gIGFuaW1hdGUoKTtcbiAgJChcIiNjYW52YXNcIikub24oICdtb3VzZW1vdmUnLCBvbkRvY3VtZW50TW91c2VNb3ZlICk7XG59KTtcblxuJChkb2N1bWVudCkub24oJ3JvdGF0aW9uVmFsdWVDaGFuZ2VkJywgZnVuY3Rpb24oZXZlbnQsIHgsIHkpIHtcbiAgY29uc29sZS5sb2coJ3JvdGF0aW9uVmFsdWVDaGFuZ2VkOiAnICsgeCArICcsICcgKyB5KTtcbiAgcnggPSB4O1xuICByeSA9IHk7XG59KTtcbiIsIlxudmFyIGNvbnRhaW5lcjtcblxudmFyIGNhbWVyYSwgc2NlbmVGaXJzdFBhc3MsIHNjZW5lU2Vjb25kUGFzcywgcmVuZGVyZXI7XG52YXIgcnRUZXh0dXJlO1xudmFyIGN1YmVUZXh0dXJlO1xudmFyIHRyYW5zZmVyVGV4dHVyZTtcblxudmFyIG1hdGVyaWFsRmlyc3RQYXNzLCBtYXRlcmlhbFNlY29uZFBhc3M7XG5cbnZhciBtZXNoLCBnZW9tZXRyeTtcbnZhciBzcGhlcmVzID0gW107XG5cbnZhciB2ZXJ0ZXhTaGFkZXIxLCBmcmFnbWVudFNoYWRlcjE7XG52YXIgdmVydGV4U2hhZGVyMiwgZnJhZ21lbnRTaGFkZXIyO1xuXG52YXIgc2NyZWVuU2l6ZSA9IHt4OiA2NDAsIHk6IDQ4MH07XG52YXIgd2luZG93SGFsZlggPSBzY3JlZW5TaXplLnggLyAyO1xudmFyIHdpbmRvd0hhbGZZID0gc2NyZWVuU2l6ZS55IC8gMjtcblxuZnVuY3Rpb24gbG9hZFJlc291cmNlKHVybCwgY2FsbGJhY2spIHtcbiAgJC5hamF4KHtcbiAgICB1cmw6IHVybCxcbiAgICBzdWNjZXNzOiBmdW5jdGlvbihkYXRhKSB7XG4gICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgZGF0YSk7XG4gICAgfSxcbiAgICBlcnJvcjogZnVuY3Rpb24oZXJyKSB7XG4gICAgICByZXR1cm4gY2FsbGJhY2soZXJyLCBudWxsKTtcbiAgICB9XG4gIH0pO1xufVxuXG4vLyBMb2FkIHNoYWRlcnNcbmZ1bmN0aW9uIGxvYWRTaGFkZXJzKCkge1xuICBjb25zb2xlLmxvZyhcIkhFTExPXCIpO1xuICBsb2FkUmVzb3VyY2UoJy9hc3NldHMvc2hhZGVycy9yYXljYXN0ZXIuZmlyc3RwYXNzLnZzJywgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XG4gICAgaWYoZXJyKSB7XG4gICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgIH1cbiAgICB2ZXJ0ZXhTaGFkZXIxID0gZGF0YTtcblxuICAgIGxvYWRSZXNvdXJjZSgnL2Fzc2V0cy9zaGFkZXJzL3JheWNhc3Rlci5maXJzdHBhc3MuZnMnLCBmdW5jdGlvbihlcnIsIGRhdGEpIHtcbiAgICAgIGlmKGVycikge1xuICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgfVxuICAgICAgZnJhZ21lbnRTaGFkZXIxID0gZGF0YTtcblxuICAgICAgbG9hZFJlc291cmNlKCcvYXNzZXRzL3NoYWRlcnMvcmF5Y2FzdGVyLnNlY29uZHBhc3MudnMnLCBmdW5jdGlvbihlcnIsIGRhdGEpIHtcbiAgICAgICAgaWYoZXJyKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgfVxuICAgICAgICB2ZXJ0ZXhTaGFkZXIyID0gZGF0YTtcblxuICAgICAgICBsb2FkUmVzb3VyY2UoJy9hc3NldHMvc2hhZGVycy9yYXljYXN0ZXIuc2Vjb25kcGFzcy5mcycsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xuICAgICAgICAgIGlmKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZnJhZ21lbnRTaGFkZXIyID0gZGF0YTtcbiAgICAgICAgICBpbml0KCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5cbmZ1bmN0aW9uIGluaXQoKSB7XG5cbiAgY29udGFpbmVyID0gJCgnI21haW4nKTtcblxuICBjYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEoIDYwLCBzY3JlZW5TaXplLngvc2NyZWVuU2l6ZS55LCAwLjEsIDEwMDAwMCApO1xuICBjYW1lcmEucG9zaXRpb24ueiA9IDI7XG5cbiAgc2NlbmVGaXJzdFBhc3MgPSBuZXcgVEhSRUUuU2NlbmUoKTtcblx0c2NlbmVTZWNvbmRQYXNzID0gbmV3IFRIUkVFLlNjZW5lKCk7XG5cbiAgY3ViZVRleHR1cmUgPSBUSFJFRS5JbWFnZVV0aWxzLmxvYWRUZXh0dXJlKCcvYXNzZXRzL2ltYWdlcy9ib25zYWkucmF3LnBuZycgKTtcbiAgY3ViZVRleHR1cmUuZ2VuZXJhdGVNaXBtYXBzID0gZmFsc2U7XG4gIGN1YmVUZXh0dXJlLm1pbkZpbHRlciA9IFRIUkVFLkxpbmVhckZpbHRlcjtcbiAgY3ViZVRleHR1cmUubWFnRmlsdGVyID0gVEhSRUUuTGluZWFyRmlsdGVyO1xuXG4gIHRyYW5zZmVyVGV4dHVyZSA9IHVwZGF0ZVRyYW5zZmVyRnVuY3Rpb24oKTtcblxuICBydFRleHR1cmUgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJUYXJnZXQoIHNjcmVlblNpemUueCwgc2NyZWVuU2l6ZS55LFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdHsgXHRtaW5GaWx0ZXI6IFRIUkVFLkxpbmVhckZpbHRlcixcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdG1hZ0ZpbHRlcjogVEhSRUUuTGluZWFyRmlsdGVyLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0d3JhcFM6ICBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0d3JhcFQ6ICBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0Zm9ybWF0OiBUSFJFRS5SR0JGb3JtYXQsXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHR0eXBlOiBUSFJFRS5GbG9hdFR5cGUsXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRnZW5lcmF0ZU1pcG1hcHM6IGZhbHNlfSApO1xuXG5cbiAgbWF0ZXJpYWxGaXJzdFBhc3MgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoIHtcbiAgXHR2ZXJ0ZXhTaGFkZXI6IHZlcnRleFNoYWRlcjEsXG4gIFx0ZnJhZ21lbnRTaGFkZXI6IGZyYWdtZW50U2hhZGVyMSxcbiAgXHRzaWRlOiBUSFJFRS5CYWNrU2lkZVxuICB9ICk7XG5cblx0bWF0ZXJpYWxTZWNvbmRQYXNzID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKCB7XG4gIFx0dmVydGV4U2hhZGVyOiB2ZXJ0ZXhTaGFkZXIyLFxuICBcdGZyYWdtZW50U2hhZGVyOiBmcmFnbWVudFNoYWRlcjIsXG5cdFx0c2lkZTogVEhSRUUuRnJvbnRTaWRlLFxuXHRcdHVuaWZvcm1zOiB7XG4gICAgICB0ZXg6ICB7XG4gICAgICAgIHR5cGU6IFwidFwiLFxuICAgICAgICB2YWx1ZTogcnRUZXh0dXJlXG4gICAgICB9LFxuXHRcdFx0Y3ViZVRleDpcbiAgICAgIHtcbiAgICAgICAgdHlwZTogXCJ0XCIsXG4gICAgICAgIHZhbHVlOiBjdWJlVGV4dHVyZVxuICAgICAgfSxcblx0XHRcdHRyYW5zZmVyVGV4OlxuICAgICAge1xuICAgICAgICB0eXBlOiBcInRcIixcbiAgICAgICAgdmFsdWU6IHRyYW5zZmVyVGV4dHVyZVxuICAgICAgfSxcblx0XHRcdHN0ZXBzIDoge1xuICAgICAgICB0eXBlOiBcIjFmXCIgLFxuICAgICAgICB2YWx1ZTogMjU2XG4gICAgICB9LFxuXHRcdFx0YWxwaGFDb3JyZWN0aW9uIDoge1xuICAgICAgICB0eXBlOiBcIjFmXCIgLFxuICAgICAgICB2YWx1ZTogMS4wXG4gICAgICB9XG4gICAgfVxuXHQgfSk7XG5cblxuICAvLyBHZW9tZXRyeSBzZXR1cFxuXHR2YXIgYm94R2VvbWV0cnkgPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoMS4wLCAxLjAsIDEuMCk7XG5cdGJveEdlb21ldHJ5LmRvdWJsZVNpZGVkID0gdHJ1ZTtcblx0dmFyIG1lc2hGaXJzdFBhc3MgPSBuZXcgVEhSRUUuTWVzaCggYm94R2VvbWV0cnksIG1hdGVyaWFsRmlyc3RQYXNzICk7XG5cdHZhciBtZXNoU2Vjb25kUGFzcyA9IG5ldyBUSFJFRS5NZXNoKCBib3hHZW9tZXRyeSwgbWF0ZXJpYWxTZWNvbmRQYXNzICk7XG5cdHNjZW5lRmlyc3RQYXNzLmFkZCggbWVzaEZpcnN0UGFzcyApO1xuXHRzY2VuZVNlY29uZFBhc3MuYWRkKCBtZXNoU2Vjb25kUGFzcyApO1xuXG5cbiAgcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcigpO1xuICByZW5kZXJlci5zZXRQaXhlbFJhdGlvKCB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyApO1xuICByZW5kZXJlci5zZXRTaXplKCBzY3JlZW5TaXplLngsIHNjcmVlblNpemUueSApO1xuICByZW5kZXJlci5hdXRvQ2xlYXIgPSB0cnVlO1xuICByZW5kZXJlci5zZXRDbGVhckNvbG9yKFwiI0ZGRkZGRlwiKTtcbiAgY29uc29sZS5sb2coXCJjbGVhciBjb2xvcjogXCIpO1xuICBjb25zb2xlLmxvZyhyZW5kZXJlci5nZXRDbGVhckNvbG9yKCkpO1xuICByZW5kZXJlci5kb21FbGVtZW50LnNldEF0dHJpYnV0ZSgnaWQnLCAnY2FudmFzJyk7XG4gIGNvbnRhaW5lci5hcHBlbmQoIHJlbmRlcmVyLmRvbUVsZW1lbnQgKTtcblxuICB2YXIgYiA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSgyLDIsMik7XG4gIHZhciBibWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHtjb2xvcjogXCIjRkYwMDAwXCJ9KTtcblxuICB2YXIgYm1lc2ggPSBuZXcgVEhSRUUuTWVzaChiLCBibWF0KTtcbiAgYm1lc2gucG9zaXRpb24ueCA9IDA7XG4gIGJtZXNoLnBvc2l0aW9uLnkgPSAwO1xuICBibWVzaC5wb3NpdGlvbi56ID0gMDtcblxuICAvL3NjZW5lU2Vjb25kUGFzcy5hZGQoYm1lc2gpO1xuXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAncmVzaXplJywgb25XaW5kb3dSZXNpemUsIGZhbHNlICk7XG5cbiAgYW5pbWF0ZSgpO1xufVxuXG5mdW5jdGlvbiBvbldpbmRvd1Jlc2l6ZSgpIHtcblxuICB3aW5kb3dIYWxmWCA9IHNjcmVlblNpemUueCAvIDI7XG4gIHdpbmRvd0hhbGZZID0gc2NyZWVuU2l6ZS55IC8gMjtcblxuICBjYW1lcmEuYXNwZWN0ID0gc2NyZWVuU2l6ZS54L3NjcmVlblNpemUueTtcbiAgY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTtcblxuICByZW5kZXJlci5zZXRTaXplKCBzY3JlZW5TaXplLngsIHNjcmVlblNpemUueSApO1xuXG59XG5cblxuZnVuY3Rpb24gYW5pbWF0ZSgpIHtcblxuICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoIGFuaW1hdGUgKTtcblxuICByZW5kZXIoKTtcblxufVxuXG5mdW5jdGlvbiByZW5kZXIoKSB7XG5cbiAgLy92YXIgZGVsdGEgPSBjbG9jay5nZXREZWx0YSgpO1xuXHQvL1JlbmRlciBmaXJzdCBwYXNzIGFuZCBzdG9yZSB0aGUgd29ybGQgc3BhY2UgY29vcmRzIG9mIHRoZSBiYWNrIGZhY2UgZnJhZ21lbnRzIGludG8gdGhlIHRleHR1cmUuXG5cdHJlbmRlcmVyLnJlbmRlciggc2NlbmVGaXJzdFBhc3MsIGNhbWVyYSwgcnRUZXh0dXJlLCB0cnVlICk7XG5cdC8vUmVuZGVyIHRoZSBzZWNvbmQgcGFzcyBhbmQgcGVyZm9ybSB0aGUgdm9sdW1lIHJlbmRlcmluZy5cblx0cmVuZGVyZXIucmVuZGVyKCBzY2VuZVNlY29uZFBhc3MsIGNhbWVyYSApO1xuXHRtYXRlcmlhbFNlY29uZFBhc3MudW5pZm9ybXMuc3RlcHMudmFsdWUgPSAyNTY7XG5cdG1hdGVyaWFsU2Vjb25kUGFzcy51bmlmb3Jtcy5hbHBoYUNvcnJlY3Rpb24udmFsdWUgPSAxLjA7XG5cbn1cblxuZnVuY3Rpb24gdXBkYXRlVGV4dHVyZXModmFsdWUpIHtcbiAgbWF0ZXJpYWxTZWNvbmRQYXNzLnVuaWZvcm1zLnRyYW5zZmVyVGV4LnZhbHVlID0gdXBkYXRlVHJhbnNmZXJGdW5jdGlvbigpO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVUcmFuc2ZlckZ1bmN0aW9uKCkge1xuXHR2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG5cdGNhbnZhcy5oZWlnaHQgPSAyMDtcblx0Y2FudmFzLndpZHRoID0gMjU2O1xuXHR2YXIgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7XG5cdHZhciBncmQgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoMCwgMCwgY2FudmFzLndpZHRoIC0xICwgY2FudmFzLmhlaWdodCAtIDEpO1xuXHRncmQuYWRkQ29sb3JTdG9wKDAuMSwgXCIjMDBGRjAwXCIpO1xuXHRncmQuYWRkQ29sb3JTdG9wKDAuNywgXCIjRkYwMDAwXCIpO1xuXHRncmQuYWRkQ29sb3JTdG9wKDEuMCwgXCIjMDAwMEZGXCIpO1xuXHRjdHguZmlsbFN0eWxlID0gZ3JkO1xuXHRjdHguZmlsbFJlY3QoMCwwLGNhbnZhcy53aWR0aCAtMSAsY2FudmFzLmhlaWdodCAtMSApO1xuXG4gIHZhciBpbWcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRyYW5zZmVyVGV4dHVyZVwiKTtcblx0XHRcdFx0aW1nLnNyYyA9IGNhbnZhcy50b0RhdGFVUkwoKTtcblx0XHRcdFx0aW1nLnN0eWxlLndpZHRoID0gXCIyNTYgcHhcIjtcblx0XHRcdFx0aW1nLnN0eWxlLmhlaWdodCA9IFwiMTI4IHB4XCI7XG5cblx0dHJhbnNmZXJUZXh0dXJlID0gIG5ldyBUSFJFRS5UZXh0dXJlKGNhbnZhcyk7XG5cdHRyYW5zZmVyVGV4dHVyZS53cmFwUyA9IHRyYW5zZmVyVGV4dHVyZS53cmFwVCA9ICBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nO1xuXHR0cmFuc2ZlclRleHR1cmUubmVlZHNVcGRhdGUgPSB0cnVlO1xuXHRyZXR1cm4gdHJhbnNmZXJUZXh0dXJlO1xufVxuXG5cbiQoZG9jdW1lbnQpLm9uKCdyZWFkeUZvckNhbnZhc1JheWNhc3RlcicsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gIGNvbnNvbGUubG9nKFwicmVhZHlGb3JDYW52YXNSYXljYXN0ZXJcIik7XG4gIGxvYWRTaGFkZXJzKCk7XG4gICQoXCIjY2FudmFzXCIpLm9uKCAnbW91c2Vtb3ZlJywgb25Eb2N1bWVudE1vdXNlTW92ZSApO1xufSk7XG5cbiQoZG9jdW1lbnQpLm9uKCdyb3RhdGlvblZhbHVlQ2hhbmdlZCcsIGZ1bmN0aW9uKGV2ZW50LCB4LCB5KSB7XG4gIGNvbnNvbGUubG9nKCdyb3RhdGlvblZhbHVlQ2hhbmdlZDogJyArIHggKyAnLCAnICsgeSk7XG4gIHJ4ID0geDtcbiAgcnkgPSB5O1xufSk7XG4iLCJcbid1c2Ugc3RyaWN0JztcblxudmFyIG1haW4gPSBhbmd1bGFyLm1vZHVsZSgnY3RNYWluJywgW10pO1xuXG5tYWluLmNvbnRyb2xsZXIoJ01haW5Db250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHtcbiAgJChkb2N1bWVudCkudHJpZ2dlcigncmVhZHlGb3JDYW52YXNSYXljYXN0ZXInKTtcblxuICAkc2NvcGUudXBkYXRlUm90YXRpb24gPSBmdW5jdGlvbigpIHtcbiAgICBjb25zb2xlLmxvZyhcIm9uQ2xpY2tSb3RhdGlvbkNoYW5nZWRcIik7XG4gICAgJChkb2N1bWVudCkudHJpZ2dlcigncm90YXRpb25WYWx1ZUNoYW5nZWQnLCBbcGFyc2VJbnQoJHNjb3BlLnJvdGF0aW9uLngpLCBwYXJzZUludCgkc2NvcGUucm90YXRpb24ueSldKTtcbiAgfTtcbn1dKTtcbiIsIiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
