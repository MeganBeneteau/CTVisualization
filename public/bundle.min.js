'use strict';

/* App Module */

var ctApp = angular.module('ctApp', [
  'ngRoute',
  'ctMain',
]);

ctApp.config(['$routeProvider',
  function($routeProvider) {
    $routeProvider.
      when('/', {
        templateUrl: 'components/Main/main.html',
        controller: 'MainController'
      }).
      otherwise({
        redirectTo: '/'
      });
  }]);

//
// var container;
//
// var camera, scene, renderer;
// var cameraCube, sceneCube;
//
// var mesh, lightMesh, geometry;
// var spheres = [];
//
// var directionalLight, pointLight;
//
// var mouseX = 0;
// var mouseY = 0;
//
// var rx = 5000;
// var ry = 5000;
//
// var windowHalfX = 640 / 2;
// var windowHalfY = 480 / 2;
//
//
// function init() {
//
//   container = $('#main');
//
//   camera = new THREE.PerspectiveCamera( 60, 640/480, 1, 100000 );
//   camera.position.z = 3200;
//
//   cameraCube = new THREE.PerspectiveCamera( 60, 640/480, 1, 100000 );
//
//   scene = new THREE.Scene();
//   sceneCube = new THREE.Scene();
//
//   var geometry = new THREE.SphereBufferGeometry( 100, 32, 16 );
//
//   var path = "assets/images/pisa/";
//   var format = '.png';
//   var urls = [
//     path + 'px' + format, path + 'nx' + format,
//     path + 'py' + format, path + 'ny' + format,
//     path + 'pz' + format, path + 'nz' + format
//   ];
//
//   var textureCube = new THREE.CubeTextureLoader().load( urls );
//   var material = new THREE.MeshBasicMaterial( { color: 0xffffff, envMap: textureCube } );
//
//   for ( var i = 0; i < 500; i ++ ) {
//
//     var mesh = new THREE.Mesh( geometry, material );
//
//     mesh.position.x = Math.random() * 10000 - 5000;
//     mesh.position.y = Math.random() * 10000 - 5000;
//     mesh.position.z = Math.random() * 10000 - 5000;
//
//     mesh.scale.x = mesh.scale.y = mesh.scale.z = Math.random() * 3 + 1;
//
//     scene.add( mesh );
//
//     spheres.push( mesh );
//
//   }
//
//   // Skybox
//
//   var shader = THREE.ShaderLib[ "cube" ];
//   shader.uniforms[ "tCube" ].value = textureCube;
//
//   var material = new THREE.ShaderMaterial( {
//
//     fragmentShader: shader.fragmentShader,
//     vertexShader: shader.vertexShader,
//     uniforms: shader.uniforms,
//     depthWrite: false,
//     side: THREE.BackSide
//
//   } ),
//
//   mesh = new THREE.Mesh( new THREE.BoxGeometry( 100, 100, 100 ), material );
//   sceneCube.add( mesh );
//
//   //
//
//   renderer = new THREE.WebGLRenderer();
//   renderer.setPixelRatio( window.devicePixelRatio );
//   renderer.setSize( 640, 480 );
//   renderer.autoClear = false;
//   renderer.domElement.setAttribute('id', 'canvas');
//   container.append( renderer.domElement );
//
//   //
//
//   window.addEventListener( 'resize', onWindowResize, false );
//
// }
//
// function onWindowResize() {
//
//   windowHalfX = 640 / 2;
//   windowHalfY = 480 / 2;
//
//   camera.aspect = 640/480;
//   camera.updateProjectionMatrix();
//
//   cameraCube.aspect = 640/480;
//   cameraCube.updateProjectionMatrix();
//
//
//   renderer.setSize( 640, 480 );
//
// }
//
// function onDocumentMouseMove( event ) {
//
//   mouseX = ( event.clientX - 640 ) * 10;
//   mouseY = ( event.clientY - 480 ) * 10;
//
// }
//
// function animate() {
//
//   requestAnimationFrame( animate );
//
//   render();
//
// }
//
// function render() {
//
//   var timer = 0.0001 * Date.now();
//
//   for ( var i = 0, il = spheres.length; i < il; i ++ ) {
//
//     var sphere = spheres[ i ];
//
//     sphere.position.x = rx * Math.cos( timer + i );
//     sphere.position.y = ry * Math.sin( timer + i * 1.1 );
//
//   }
//
//   camera.position.x += ( mouseX - camera.position.x ) * 0.05;
//   camera.position.y += ( - mouseY - camera.position.y ) * 0.05;
//
//   camera.lookAt( scene.position );
//   cameraCube.rotation.copy( camera.rotation );
//
//   renderer.render( sceneCube, cameraCube );
//   renderer.render( scene, camera );
//
// }
//
//
// $(document).on('readyForCanvas', function(event) {
//   console.log("readyForCanvas");
//   init();
//   animate();
//   $("#canvas").on( 'mousemove', onDocumentMouseMove );
// });
//
// $(document).on('rotationValueChanged', function(event, x, y) {
//   console.log('rotationValueChanged: ' + x + ', ' + y);
//   rx = x;
//   ry = y;
// });


var container;

var camera, sceneFirstPass, sceneSecondPass, renderer;
var rtTexture;
var cubeTexture;
var transferTexture;

var materialFirstPass, materialSecondPass;

var mesh, geometry;
var spheres = [];

var vertexShader1, fragmentShader1;
var vertexShader2, fragmentShader2;

var screenSize = {x: 640, y: 480};
var windowHalfX = screenSize.x / 2;
var windowHalfY = screenSize.y / 2;

function loadResource(url, callback) {
  $.ajax({
    url: url,
    success: function(data) {
      return callback(null, data);
    },
    error: function(err) {
      return callback(err, null);
    }
  });
}

// Load shaders
function loadShaders() {
  loadResource('/assets/shaders/raycaster.firstpass.vs', function(err, data) {
    if(err) {
      console.log(err);
    }
    vertexShader1 = data;

    loadResource('/assets/shaders/raycaster.firstpass.fs', function(err, data) {
      if(err) {
        console.log(err);
      }
      fragmentShader1 = data;

      loadResource('/assets/shaders/raycaster.secondpass.vs', function(err, data) {
        if(err) {
          console.log(err);
        }
        vertexShader2 = data;

        loadResource('/assets/shaders/raycaster.secondpass.fs', function(err, data) {
          if(err) {
            console.log(err);
          }
          fragmentShader2 = data;
          init();
        });
      });
    });
  });
}


function init() {

  container = $('#main');

  camera = new THREE.PerspectiveCamera( 60, screenSize.x/screenSize.y, 0.1, 100000 );
  camera.position.z = 2;

  sceneFirstPass = new THREE.Scene();
	sceneSecondPass = new THREE.Scene();

  var randomdata = [];
  for( var i = 0; i < 64; i++) {
    randomdata[i] = [];
    for( var j = 0; j < 64; j++) {
      randomdata[i][j] = [];
      for( var k = 0; k < 64; k++) {
        randomdata[i][j].push(Math.floor(Math.random()*4095));
        if(Math.random()*1 >= 1/64.0*i*1.1) {
          randomdata[i][j][k] = 0.0;
        }
      }
    }
    console.log("random data progress: " + i/64 + " %");
  }

  mosaic.createMosaicImage(64,64,randomdata, function(canvas) {//THREE.ImageUtils.loadTexture('/assets/images/bonsai.raw.png' );
    cubeTexture = new THREE.Texture(canvas);
    cubeTexture.needsUpdate = true;
    console.log(cubeTexture);
    //cubeTexture = THREE.ImageUtils.loadTexture('/assets/images/bonsai.raw.png');
    cubeTexture.generateMipmaps = false;
    cubeTexture.minFilter = THREE.LinearFilter;
    cubeTexture.magFilter = THREE.LinearFilter;

    //$("#test").append(image);

    transferTexture = updateTransferFunction();

    rtTexture = new THREE.WebGLRenderTarget( screenSize.x, screenSize.y,
  														{ 	minFilter: THREE.LinearFilter,
  															magFilter: THREE.LinearFilter,
  															wrapS:  THREE.ClampToEdgeWrapping,
  															wrapT:  THREE.ClampToEdgeWrapping,
  															format: THREE.RGBFormat,
  															type: THREE.FloatType,
  															generateMipmaps: false} );


    materialFirstPass = new THREE.ShaderMaterial( {
    	vertexShader: vertexShader1,
    	fragmentShader: fragmentShader1,
    	side: THREE.BackSide
    } );

  	materialSecondPass = new THREE.ShaderMaterial( {
    	vertexShader: vertexShader2,
    	fragmentShader: fragmentShader2,
  		side: THREE.FrontSide,
  		uniforms: {
        tex:  {
          type: "t",
          value: rtTexture
        },
  			cubeTex:
        {
          type: "t",
          value: cubeTexture
        },
  			transferTex:
        {
          type: "t",
          value: transferTexture
        },
  			steps : {
          type: "1f" ,
          value: 64
        },
  			alphaCorrection : {
          type: "1f" ,
          value: 1.0
        }
      }
  	 });


    // Geometry setup
  	var boxGeometry = new THREE.BoxGeometry(1.0, 1.0, 1.0);
  	boxGeometry.doubleSided = true;
  	var meshFirstPass = new THREE.Mesh( boxGeometry, materialFirstPass );
  	var meshSecondPass = new THREE.Mesh( boxGeometry, materialSecondPass );
  	sceneFirstPass.add( meshFirstPass );
  	sceneSecondPass.add( meshSecondPass );


    renderer = new THREE.WebGLRenderer();
    renderer.setPixelRatio( window.devicePixelRatio );
    renderer.setSize( screenSize.x, screenSize.y );
    renderer.autoClear = true;
    renderer.setClearColor("#FFFFFF");
    console.log("clear color: ");
    console.log(renderer.getClearColor());
    renderer.domElement.setAttribute('id', 'canvas');
    container.append( renderer.domElement );

    var b = new THREE.BoxGeometry(2,2,2);
    var bmat = new THREE.MeshBasicMaterial({color: "#FF0000"});

    var bmesh = new THREE.Mesh(b, bmat);
    bmesh.position.x = 0;
    bmesh.position.y = 0;
    bmesh.position.z = 0;

    //sceneSecondPass.add(bmesh);

    window.addEventListener( 'resize', onWindowResize, false );

    animate();
  });
}

function onWindowResize() {

  windowHalfX = screenSize.x / 2;
  windowHalfY = screenSize.y / 2;

  camera.aspect = screenSize.x/screenSize.y;
  camera.updateProjectionMatrix();

  renderer.setSize( screenSize.x, screenSize.y );

}


function animate() {

  requestAnimationFrame( animate );

  render();

}

function render() {

  //var delta = clock.getDelta();
	//Render first pass and store the world space coords of the back face fragments into the texture.
	renderer.render( sceneFirstPass, camera, rtTexture, true );
	//Render the second pass and perform the volume rendering.
	renderer.render( sceneSecondPass, camera );
	materialSecondPass.uniforms.steps.value = 256;
	materialSecondPass.uniforms.alphaCorrection.value = 1.0;

}

function updateTextures(value) {
  materialSecondPass.uniforms.transferTex.value = updateTransferFunction();
}

function updateTransferFunction() {
	var canvas = document.createElement('canvas');
	canvas.height = 20;
	canvas.width = 256;
	var ctx = canvas.getContext('2d');
	var grd = ctx.createLinearGradient(0, 0, canvas.width -1 , canvas.height - 1);
	grd.addColorStop(0.1, "#00FF00");
	grd.addColorStop(0.7, "#FF0000");
	grd.addColorStop(1.0, "#0000FF");
	ctx.fillStyle = grd;
	ctx.fillRect(0,0,canvas.width -1 ,canvas.height -1 );

  var img = document.getElementById("transferTexture");
				img.src = canvas.toDataURL();
				img.style.width = "256 px";
				img.style.height = "20 px";

	transferTexture =  new THREE.Texture(canvas);
	transferTexture.wrapS = transferTexture.wrapT =  THREE.ClampToEdgeWrapping;
	transferTexture.needsUpdate = true;
	return transferTexture;
}


$(document).on('readyForCanvasRaycaster', function(event) {
  console.log("readyForCanvasRaycaster");
  loadShaders();
  $("#canvas").on( 'mousemove', onDocumentMouseMove );
});

$(document).on('rotationValueChanged', function(event, x, y) {
  console.log('rotationValueChanged: ' + x + ', ' + y);
  rx = x;
  ry = y;
});

//
// var container;
//
// var camera, scene, renderer;
//
// var mesh,geometry;
//
// var windowHalfX = 640 / 2;
// var windowHalfY = 480 / 2;
//
//
// function init() {
//
//   container = $('#main');
//
//   camera = new THREE.PerspectiveCamera( 60, 640/480, 1, 100000 );
//   camera.position.z = 200;
//
//   scene = new THREE.Scene();
//
//   var randomdata = [];
//   for( var i = 0; i < 64; i++) {
//     randomdata[i] = [];
//     for( var j = 0; j < 64; j++) {
//       randomdata[i][j] = [];
//       for( var k = 0; k < 64; k++) {
//         randomdata[i][j].push(Math.floor(Math.random()*4095));
//         if(Math.random()*1 >= 1/64.0*i*1.1) {
//           randomdata[i][j][k] = 0.0;
//         }
//       }
//     }
//     console.log("random data progress: " + Math.floor(i/64*100) + " %");
//   }
//   mosaic.createMosaicImage(64,64,randomdata, function(canvas) {
//     //console.log(img);
//
//   //  container.append(img);
//     var tex = new THREE.Texture(canvas);
//     tex.needsUpdate = true;
//
//     var mat = new THREE.MeshBasicMaterial({map: tex});
//
//     mesh = new THREE.Mesh( new THREE.BoxGeometry( 100, 100, 100 ), mat );
//     scene.add( mesh );
//
//     //
//
//     renderer = new THREE.WebGLRenderer();
//     renderer.setPixelRatio( window.devicePixelRatio );
//     renderer.setSize( 640, 480 );
//     renderer.setClearColor(0xFFFFFF);
//     //renderer.autoClear = false;
//     renderer.domElement.setAttribute('id', 'canvas');
//     container.append( renderer.domElement );
//
//     window.addEventListener( 'resize', onWindowResize, false );
//   });
// }
//
// function onWindowResize() {
//
//   windowHalfX = 640 / 2;
//   windowHalfY = 480 / 2;
//
//   camera.aspect = 640/480;
//   camera.updateProjectionMatrix();
//
//
//   renderer.setSize( 640, 480 );
//
// }
//
// function animate() {
//
//   requestAnimationFrame( animate );
//
//   render();
//
// }
// 
// function render() {
//
//   renderer.render( scene, camera );
//
// }
//
//
// $(document).on('readyForCanvas', function(event) {
//   console.log("readyForCanvas");
//   init();
//   animate();
// });


'use strict';

var main = angular.module('ctMain', []);

main.controller('MainController', ['$scope', function($scope) {
  $(document).trigger('readyForCanvasRaycaster');
  $(document).trigger('readyForCanvas');

  // var randomdata = [];
  // for( var i = 0; i < 128; i++) {
  //   randomdata[i] = [];
  //   for( var j = 0; j < 128; j++) {
  //     randomdata[i][j] = [];
  //     for( var k = 0; k < 128; k++) {
  //       randomdata[i][j].push(Math.floor(Math.random()*4095));
  //     }
  //   }
  //   console.log("random data progress: " + i/128) + " %";
  // }
//  console.log("Hello mosaic");
//  $("#test").append(mosaic.createMosaicImage(128, 128, randomdata));
}]);


var mosaic = {};

mosaic.createOneImage = function(sizex, sizey, data) {
	var canvas = document.createElement("canvas");
	canvas.setAttribute("width", sizex);
	canvas.setAttribute("height", sizey);
	var ctx = canvas.getContext('2d');

	for(var i = 0; i < data.length; i++) {
		for(var j = 0; j < data[0].length; j++) {
			var id = ctx.createImageData(1,1);
			var msb = data[i][j] & 0xFF00;
			msb = msb >> 8;
			var lsb = data[i][j] & 0x00FF;
			// Use bitmask for spliting the uint16 value into two uint8 to fit into img
			id.data[0] = msb;	// r
			id.data[1] = lsb;	// g
			id.data[2] = 0;	// b
			id.data[3] = 255;//Math.floor(data[i][j]/4095*255);	// a
			ctx.putImageData(id, j, i); // row based, so add to x=j, y=i
			//console.log("calc: " + (id.data[0]*255.0*256.0 + id.data[1]*255.0)/4096.0/255.0);
		}
	}

	var image = new Image();
	image.src = canvas.toDataURL("/image/png");
	return image;
}

mosaic.createMosaicImage = function(sizex, sizey, data, callback) {
	var canvas = document.createElement("canvas");
	canvas.setAttribute("width", sizex*8);
	canvas.setAttribute("height", sizey*8);
	var ctx = canvas.getContext('2d');

	for(var i = 0; i < 8; i++) {
		for(var j = 0; j < 8; j++) {
			var image = this.createOneImage(sizex, sizey, data[i*j+j]);
			ctx.drawImage(image, sizex*i, sizey*j, sizex, sizey);
			console.log("image generation progress: " + Math.floor((i*j+j)/data.length*100) + " %");
		}
	}
//	var img = new Image();
	//img.src = canvas.toDataURL("/image/png");
	callback(canvas);
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsInRocmVlanMvcmF5Y2FzdGVyLmpzIiwiY29tcG9uZW50cy9NYWluL21haW5Db250cm9sbGVyLmpzIiwidGhyZWVqcy91dGlscy9jcmVhdGVNb3NhaWNJbWFnZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUlBLElBQUEsUUFBQSxRQUFBLE9BQUEsU0FBQTtFQUNBO0VBQ0E7OztBQUdBLE1BQUEsT0FBQSxDQUFBO0VBQ0EsU0FBQSxnQkFBQTtJQUNBO01BQ0EsS0FBQSxLQUFBO1FBQ0EsYUFBQTtRQUNBLFlBQUE7O01BRUEsVUFBQTtRQUNBLFlBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUNoQkEsSUFBQTs7QUFFQSxJQUFBLFFBQUEsZ0JBQUEsaUJBQUE7QUFDQSxJQUFBO0FBQ0EsSUFBQTtBQUNBLElBQUE7O0FBRUEsSUFBQSxtQkFBQTs7QUFFQSxJQUFBLE1BQUE7QUFDQSxJQUFBLFVBQUE7O0FBRUEsSUFBQSxlQUFBO0FBQ0EsSUFBQSxlQUFBOztBQUVBLElBQUEsYUFBQSxDQUFBLEdBQUEsS0FBQSxHQUFBO0FBQ0EsSUFBQSxjQUFBLFdBQUEsSUFBQTtBQUNBLElBQUEsY0FBQSxXQUFBLElBQUE7O0FBRUEsU0FBQSxhQUFBLEtBQUEsVUFBQTtFQUNBLEVBQUEsS0FBQTtJQUNBLEtBQUE7SUFDQSxTQUFBLFNBQUEsTUFBQTtNQUNBLE9BQUEsU0FBQSxNQUFBOztJQUVBLE9BQUEsU0FBQSxLQUFBO01BQ0EsT0FBQSxTQUFBLEtBQUE7Ozs7OztBQU1BLFNBQUEsY0FBQTtFQUNBLGFBQUEsMENBQUEsU0FBQSxLQUFBLE1BQUE7SUFDQSxHQUFBLEtBQUE7TUFDQSxRQUFBLElBQUE7O0lBRUEsZ0JBQUE7O0lBRUEsYUFBQSwwQ0FBQSxTQUFBLEtBQUEsTUFBQTtNQUNBLEdBQUEsS0FBQTtRQUNBLFFBQUEsSUFBQTs7TUFFQSxrQkFBQTs7TUFFQSxhQUFBLDJDQUFBLFNBQUEsS0FBQSxNQUFBO1FBQ0EsR0FBQSxLQUFBO1VBQ0EsUUFBQSxJQUFBOztRQUVBLGdCQUFBOztRQUVBLGFBQUEsMkNBQUEsU0FBQSxLQUFBLE1BQUE7VUFDQSxHQUFBLEtBQUE7WUFDQSxRQUFBLElBQUE7O1VBRUEsa0JBQUE7VUFDQTs7Ozs7Ozs7QUFRQSxTQUFBLE9BQUE7O0VBRUEsWUFBQSxFQUFBOztFQUVBLFNBQUEsSUFBQSxNQUFBLG1CQUFBLElBQUEsV0FBQSxFQUFBLFdBQUEsR0FBQSxLQUFBO0VBQ0EsT0FBQSxTQUFBLElBQUE7O0VBRUEsaUJBQUEsSUFBQSxNQUFBO0NBQ0Esa0JBQUEsSUFBQSxNQUFBOztFQUVBLElBQUEsYUFBQTtFQUNBLEtBQUEsSUFBQSxJQUFBLEdBQUEsSUFBQSxJQUFBLEtBQUE7SUFDQSxXQUFBLEtBQUE7SUFDQSxLQUFBLElBQUEsSUFBQSxHQUFBLElBQUEsSUFBQSxLQUFBO01BQ0EsV0FBQSxHQUFBLEtBQUE7TUFDQSxLQUFBLElBQUEsSUFBQSxHQUFBLElBQUEsSUFBQSxLQUFBO1FBQ0EsV0FBQSxHQUFBLEdBQUEsS0FBQSxLQUFBLE1BQUEsS0FBQSxTQUFBO1FBQ0EsR0FBQSxLQUFBLFNBQUEsS0FBQSxFQUFBLEtBQUEsRUFBQSxLQUFBO1VBQ0EsV0FBQSxHQUFBLEdBQUEsS0FBQTs7OztJQUlBLFFBQUEsSUFBQSwyQkFBQSxFQUFBLEtBQUE7OztFQUdBLE9BQUEsa0JBQUEsR0FBQSxHQUFBLFlBQUEsU0FBQSxRQUFBO0lBQ0EsY0FBQSxJQUFBLE1BQUEsUUFBQTtJQUNBLFlBQUEsY0FBQTtJQUNBLFFBQUEsSUFBQTs7SUFFQSxZQUFBLGtCQUFBO0lBQ0EsWUFBQSxZQUFBLE1BQUE7SUFDQSxZQUFBLFlBQUEsTUFBQTs7OztJQUlBLGtCQUFBOztJQUVBLFlBQUEsSUFBQSxNQUFBLG1CQUFBLFdBQUEsR0FBQSxXQUFBO2dCQUNBLEdBQUEsV0FBQSxNQUFBO2lCQUNBLFdBQUEsTUFBQTtpQkFDQSxRQUFBLE1BQUE7aUJBQ0EsUUFBQSxNQUFBO2lCQUNBLFFBQUEsTUFBQTtpQkFDQSxNQUFBLE1BQUE7aUJBQ0EsaUJBQUE7OztJQUdBLG9CQUFBLElBQUEsTUFBQSxnQkFBQTtLQUNBLGNBQUE7S0FDQSxnQkFBQTtLQUNBLE1BQUEsTUFBQTs7O0dBR0EscUJBQUEsSUFBQSxNQUFBLGdCQUFBO0tBQ0EsY0FBQTtLQUNBLGdCQUFBO0lBQ0EsTUFBQSxNQUFBO0lBQ0EsVUFBQTtRQUNBLE1BQUE7VUFDQSxNQUFBO1VBQ0EsT0FBQTs7S0FFQTtRQUNBO1VBQ0EsTUFBQTtVQUNBLE9BQUE7O0tBRUE7UUFDQTtVQUNBLE1BQUE7VUFDQSxPQUFBOztLQUVBLFFBQUE7VUFDQSxNQUFBO1VBQ0EsT0FBQTs7S0FFQSxrQkFBQTtVQUNBLE1BQUE7VUFDQSxPQUFBOzs7Ozs7O0dBT0EsSUFBQSxjQUFBLElBQUEsTUFBQSxZQUFBLEtBQUEsS0FBQTtHQUNBLFlBQUEsY0FBQTtHQUNBLElBQUEsZ0JBQUEsSUFBQSxNQUFBLE1BQUEsYUFBQTtHQUNBLElBQUEsaUJBQUEsSUFBQSxNQUFBLE1BQUEsYUFBQTtHQUNBLGVBQUEsS0FBQTtHQUNBLGdCQUFBLEtBQUE7OztJQUdBLFdBQUEsSUFBQSxNQUFBO0lBQ0EsU0FBQSxlQUFBLE9BQUE7SUFDQSxTQUFBLFNBQUEsV0FBQSxHQUFBLFdBQUE7SUFDQSxTQUFBLFlBQUE7SUFDQSxTQUFBLGNBQUE7SUFDQSxRQUFBLElBQUE7SUFDQSxRQUFBLElBQUEsU0FBQTtJQUNBLFNBQUEsV0FBQSxhQUFBLE1BQUE7SUFDQSxVQUFBLFFBQUEsU0FBQTs7SUFFQSxJQUFBLElBQUEsSUFBQSxNQUFBLFlBQUEsRUFBQSxFQUFBO0lBQ0EsSUFBQSxPQUFBLElBQUEsTUFBQSxrQkFBQSxDQUFBLE9BQUE7O0lBRUEsSUFBQSxRQUFBLElBQUEsTUFBQSxLQUFBLEdBQUE7SUFDQSxNQUFBLFNBQUEsSUFBQTtJQUNBLE1BQUEsU0FBQSxJQUFBO0lBQ0EsTUFBQSxTQUFBLElBQUE7Ozs7SUFJQSxPQUFBLGtCQUFBLFVBQUEsZ0JBQUE7O0lBRUE7Ozs7QUFJQSxTQUFBLGlCQUFBOztFQUVBLGNBQUEsV0FBQSxJQUFBO0VBQ0EsY0FBQSxXQUFBLElBQUE7O0VBRUEsT0FBQSxTQUFBLFdBQUEsRUFBQSxXQUFBO0VBQ0EsT0FBQTs7RUFFQSxTQUFBLFNBQUEsV0FBQSxHQUFBLFdBQUE7Ozs7O0FBS0EsU0FBQSxVQUFBOztFQUVBLHVCQUFBOztFQUVBOzs7O0FBSUEsU0FBQSxTQUFBOzs7O0NBSUEsU0FBQSxRQUFBLGdCQUFBLFFBQUEsV0FBQTs7Q0FFQSxTQUFBLFFBQUEsaUJBQUE7Q0FDQSxtQkFBQSxTQUFBLE1BQUEsUUFBQTtDQUNBLG1CQUFBLFNBQUEsZ0JBQUEsUUFBQTs7OztBQUlBLFNBQUEsZUFBQSxPQUFBO0VBQ0EsbUJBQUEsU0FBQSxZQUFBLFFBQUE7OztBQUdBLFNBQUEseUJBQUE7Q0FDQSxJQUFBLFNBQUEsU0FBQSxjQUFBO0NBQ0EsT0FBQSxTQUFBO0NBQ0EsT0FBQSxRQUFBO0NBQ0EsSUFBQSxNQUFBLE9BQUEsV0FBQTtDQUNBLElBQUEsTUFBQSxJQUFBLHFCQUFBLEdBQUEsR0FBQSxPQUFBLE9BQUEsSUFBQSxPQUFBLFNBQUE7Q0FDQSxJQUFBLGFBQUEsS0FBQTtDQUNBLElBQUEsYUFBQSxLQUFBO0NBQ0EsSUFBQSxhQUFBLEtBQUE7Q0FDQSxJQUFBLFlBQUE7Q0FDQSxJQUFBLFNBQUEsRUFBQSxFQUFBLE9BQUEsT0FBQSxHQUFBLE9BQUEsUUFBQTs7RUFFQSxJQUFBLE1BQUEsU0FBQSxlQUFBO0lBQ0EsSUFBQSxNQUFBLE9BQUE7SUFDQSxJQUFBLE1BQUEsUUFBQTtJQUNBLElBQUEsTUFBQSxTQUFBOztDQUVBLG1CQUFBLElBQUEsTUFBQSxRQUFBO0NBQ0EsZ0JBQUEsUUFBQSxnQkFBQSxTQUFBLE1BQUE7Q0FDQSxnQkFBQSxjQUFBO0NBQ0EsT0FBQTs7OztBQUlBLEVBQUEsVUFBQSxHQUFBLDJCQUFBLFNBQUEsT0FBQTtFQUNBLFFBQUEsSUFBQTtFQUNBO0VBQ0EsRUFBQSxXQUFBLElBQUEsYUFBQTs7O0FBR0EsRUFBQSxVQUFBLEdBQUEsd0JBQUEsU0FBQSxPQUFBLEdBQUEsR0FBQTtFQUNBLFFBQUEsSUFBQSwyQkFBQSxJQUFBLE9BQUE7RUFDQSxLQUFBO0VBQ0EsS0FBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUM5UEE7O0FBRUEsSUFBQSxPQUFBLFFBQUEsT0FBQSxVQUFBOztBQUVBLEtBQUEsV0FBQSxrQkFBQSxDQUFBLFVBQUEsU0FBQSxRQUFBO0VBQ0EsRUFBQSxVQUFBLFFBQUE7RUFDQSxFQUFBLFVBQUEsUUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FDUEEsSUFBQSxTQUFBOztBQUVBLE9BQUEsaUJBQUEsU0FBQSxPQUFBLE9BQUEsTUFBQTtDQUNBLElBQUEsU0FBQSxTQUFBLGNBQUE7Q0FDQSxPQUFBLGFBQUEsU0FBQTtDQUNBLE9BQUEsYUFBQSxVQUFBO0NBQ0EsSUFBQSxNQUFBLE9BQUEsV0FBQTs7Q0FFQSxJQUFBLElBQUEsSUFBQSxHQUFBLElBQUEsS0FBQSxRQUFBLEtBQUE7RUFDQSxJQUFBLElBQUEsSUFBQSxHQUFBLElBQUEsS0FBQSxHQUFBLFFBQUEsS0FBQTtHQUNBLElBQUEsS0FBQSxJQUFBLGdCQUFBLEVBQUE7R0FDQSxJQUFBLE1BQUEsS0FBQSxHQUFBLEtBQUE7R0FDQSxNQUFBLE9BQUE7R0FDQSxJQUFBLE1BQUEsS0FBQSxHQUFBLEtBQUE7O0dBRUEsR0FBQSxLQUFBLEtBQUE7R0FDQSxHQUFBLEtBQUEsS0FBQTtHQUNBLEdBQUEsS0FBQSxLQUFBO0dBQ0EsR0FBQSxLQUFBLEtBQUE7R0FDQSxJQUFBLGFBQUEsSUFBQSxHQUFBOzs7OztDQUtBLElBQUEsUUFBQSxJQUFBO0NBQ0EsTUFBQSxNQUFBLE9BQUEsVUFBQTtDQUNBLE9BQUE7OztBQUdBLE9BQUEsb0JBQUEsU0FBQSxPQUFBLE9BQUEsTUFBQSxVQUFBO0NBQ0EsSUFBQSxTQUFBLFNBQUEsY0FBQTtDQUNBLE9BQUEsYUFBQSxTQUFBLE1BQUE7Q0FDQSxPQUFBLGFBQUEsVUFBQSxNQUFBO0NBQ0EsSUFBQSxNQUFBLE9BQUEsV0FBQTs7Q0FFQSxJQUFBLElBQUEsSUFBQSxHQUFBLElBQUEsR0FBQSxLQUFBO0VBQ0EsSUFBQSxJQUFBLElBQUEsR0FBQSxJQUFBLEdBQUEsS0FBQTtHQUNBLElBQUEsUUFBQSxLQUFBLGVBQUEsT0FBQSxPQUFBLEtBQUEsRUFBQSxFQUFBO0dBQ0EsSUFBQSxVQUFBLE9BQUEsTUFBQSxHQUFBLE1BQUEsR0FBQSxPQUFBO0dBQ0EsUUFBQSxJQUFBLGdDQUFBLEtBQUEsTUFBQSxDQUFBLEVBQUEsRUFBQSxHQUFBLEtBQUEsT0FBQSxPQUFBOzs7OztDQUtBLFNBQUE7O0FBRUEiLCJmaWxlIjoiYnVuZGxlLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuLyogQXBwIE1vZHVsZSAqL1xuXG52YXIgY3RBcHAgPSBhbmd1bGFyLm1vZHVsZSgnY3RBcHAnLCBbXG4gICduZ1JvdXRlJyxcbiAgJ2N0TWFpbicsXG5dKTtcblxuY3RBcHAuY29uZmlnKFsnJHJvdXRlUHJvdmlkZXInLFxuICBmdW5jdGlvbigkcm91dGVQcm92aWRlcikge1xuICAgICRyb3V0ZVByb3ZpZGVyLlxuICAgICAgd2hlbignLycsIHtcbiAgICAgICAgdGVtcGxhdGVVcmw6ICdjb21wb25lbnRzL01haW4vbWFpbi5odG1sJyxcbiAgICAgICAgY29udHJvbGxlcjogJ01haW5Db250cm9sbGVyJ1xuICAgICAgfSkuXG4gICAgICBvdGhlcndpc2Uoe1xuICAgICAgICByZWRpcmVjdFRvOiAnLydcbiAgICAgIH0pO1xuICB9XSk7XG4iLCJcbnZhciBjb250YWluZXI7XG5cbnZhciBjYW1lcmEsIHNjZW5lRmlyc3RQYXNzLCBzY2VuZVNlY29uZFBhc3MsIHJlbmRlcmVyO1xudmFyIHJ0VGV4dHVyZTtcbnZhciBjdWJlVGV4dHVyZTtcbnZhciB0cmFuc2ZlclRleHR1cmU7XG5cbnZhciBtYXRlcmlhbEZpcnN0UGFzcywgbWF0ZXJpYWxTZWNvbmRQYXNzO1xuXG52YXIgbWVzaCwgZ2VvbWV0cnk7XG52YXIgc3BoZXJlcyA9IFtdO1xuXG52YXIgdmVydGV4U2hhZGVyMSwgZnJhZ21lbnRTaGFkZXIxO1xudmFyIHZlcnRleFNoYWRlcjIsIGZyYWdtZW50U2hhZGVyMjtcblxudmFyIHNjcmVlblNpemUgPSB7eDogNjQwLCB5OiA0ODB9O1xudmFyIHdpbmRvd0hhbGZYID0gc2NyZWVuU2l6ZS54IC8gMjtcbnZhciB3aW5kb3dIYWxmWSA9IHNjcmVlblNpemUueSAvIDI7XG5cbmZ1bmN0aW9uIGxvYWRSZXNvdXJjZSh1cmwsIGNhbGxiYWNrKSB7XG4gICQuYWpheCh7XG4gICAgdXJsOiB1cmwsXG4gICAgc3VjY2VzczogZnVuY3Rpb24oZGF0YSkge1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIGRhdGEpO1xuICAgIH0sXG4gICAgZXJyb3I6IGZ1bmN0aW9uKGVycikge1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKGVyciwgbnVsbCk7XG4gICAgfVxuICB9KTtcbn1cblxuLy8gTG9hZCBzaGFkZXJzXG5mdW5jdGlvbiBsb2FkU2hhZGVycygpIHtcbiAgbG9hZFJlc291cmNlKCcvYXNzZXRzL3NoYWRlcnMvcmF5Y2FzdGVyLmZpcnN0cGFzcy52cycsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xuICAgIGlmKGVycikge1xuICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICB9XG4gICAgdmVydGV4U2hhZGVyMSA9IGRhdGE7XG5cbiAgICBsb2FkUmVzb3VyY2UoJy9hc3NldHMvc2hhZGVycy9yYXljYXN0ZXIuZmlyc3RwYXNzLmZzJywgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XG4gICAgICBpZihlcnIpIHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgIH1cbiAgICAgIGZyYWdtZW50U2hhZGVyMSA9IGRhdGE7XG5cbiAgICAgIGxvYWRSZXNvdXJjZSgnL2Fzc2V0cy9zaGFkZXJzL3JheWNhc3Rlci5zZWNvbmRwYXNzLnZzJywgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XG4gICAgICAgIGlmKGVycikge1xuICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgIH1cbiAgICAgICAgdmVydGV4U2hhZGVyMiA9IGRhdGE7XG5cbiAgICAgICAgbG9hZFJlc291cmNlKCcvYXNzZXRzL3NoYWRlcnMvcmF5Y2FzdGVyLnNlY29uZHBhc3MuZnMnLCBmdW5jdGlvbihlcnIsIGRhdGEpIHtcbiAgICAgICAgICBpZihlcnIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGZyYWdtZW50U2hhZGVyMiA9IGRhdGE7XG4gICAgICAgICAgaW5pdCgpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn1cblxuXG5mdW5jdGlvbiBpbml0KCkge1xuXG4gIGNvbnRhaW5lciA9ICQoJyNtYWluJyk7XG5cbiAgY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKCA2MCwgc2NyZWVuU2l6ZS54L3NjcmVlblNpemUueSwgMC4xLCAxMDAwMDAgKTtcbiAgY2FtZXJhLnBvc2l0aW9uLnogPSAyO1xuXG4gIHNjZW5lRmlyc3RQYXNzID0gbmV3IFRIUkVFLlNjZW5lKCk7XG5cdHNjZW5lU2Vjb25kUGFzcyA9IG5ldyBUSFJFRS5TY2VuZSgpO1xuXG4gIHZhciByYW5kb21kYXRhID0gW107XG4gIGZvciggdmFyIGkgPSAwOyBpIDwgNjQ7IGkrKykge1xuICAgIHJhbmRvbWRhdGFbaV0gPSBbXTtcbiAgICBmb3IoIHZhciBqID0gMDsgaiA8IDY0OyBqKyspIHtcbiAgICAgIHJhbmRvbWRhdGFbaV1bal0gPSBbXTtcbiAgICAgIGZvciggdmFyIGsgPSAwOyBrIDwgNjQ7IGsrKykge1xuICAgICAgICByYW5kb21kYXRhW2ldW2pdLnB1c2goTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpKjQwOTUpKTtcbiAgICAgICAgaWYoTWF0aC5yYW5kb20oKSoxID49IDEvNjQuMCppKjEuMSkge1xuICAgICAgICAgIHJhbmRvbWRhdGFbaV1bal1ba10gPSAwLjA7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgY29uc29sZS5sb2coXCJyYW5kb20gZGF0YSBwcm9ncmVzczogXCIgKyBpLzY0ICsgXCIgJVwiKTtcbiAgfVxuXG4gIG1vc2FpYy5jcmVhdGVNb3NhaWNJbWFnZSg2NCw2NCxyYW5kb21kYXRhLCBmdW5jdGlvbihjYW52YXMpIHsvL1RIUkVFLkltYWdlVXRpbHMubG9hZFRleHR1cmUoJy9hc3NldHMvaW1hZ2VzL2JvbnNhaS5yYXcucG5nJyApO1xuICAgIGN1YmVUZXh0dXJlID0gbmV3IFRIUkVFLlRleHR1cmUoY2FudmFzKTtcbiAgICBjdWJlVGV4dHVyZS5uZWVkc1VwZGF0ZSA9IHRydWU7XG4gICAgY29uc29sZS5sb2coY3ViZVRleHR1cmUpO1xuICAgIC8vY3ViZVRleHR1cmUgPSBUSFJFRS5JbWFnZVV0aWxzLmxvYWRUZXh0dXJlKCcvYXNzZXRzL2ltYWdlcy9ib25zYWkucmF3LnBuZycpO1xuICAgIGN1YmVUZXh0dXJlLmdlbmVyYXRlTWlwbWFwcyA9IGZhbHNlO1xuICAgIGN1YmVUZXh0dXJlLm1pbkZpbHRlciA9IFRIUkVFLkxpbmVhckZpbHRlcjtcbiAgICBjdWJlVGV4dHVyZS5tYWdGaWx0ZXIgPSBUSFJFRS5MaW5lYXJGaWx0ZXI7XG5cbiAgICAvLyQoXCIjdGVzdFwiKS5hcHBlbmQoaW1hZ2UpO1xuXG4gICAgdHJhbnNmZXJUZXh0dXJlID0gdXBkYXRlVHJhbnNmZXJGdW5jdGlvbigpO1xuXG4gICAgcnRUZXh0dXJlID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyVGFyZ2V0KCBzY3JlZW5TaXplLngsIHNjcmVlblNpemUueSxcbiAgXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdHsgXHRtaW5GaWx0ZXI6IFRIUkVFLkxpbmVhckZpbHRlcixcbiAgXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0bWFnRmlsdGVyOiBUSFJFRS5MaW5lYXJGaWx0ZXIsXG4gIFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdHdyYXBTOiAgVEhSRUUuQ2xhbXBUb0VkZ2VXcmFwcGluZyxcbiAgXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0d3JhcFQ6ICBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nLFxuICBcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRmb3JtYXQ6IFRIUkVFLlJHQkZvcm1hdCxcbiAgXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0dHlwZTogVEhSRUUuRmxvYXRUeXBlLFxuICBcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRnZW5lcmF0ZU1pcG1hcHM6IGZhbHNlfSApO1xuXG5cbiAgICBtYXRlcmlhbEZpcnN0UGFzcyA9IG5ldyBUSFJFRS5TaGFkZXJNYXRlcmlhbCgge1xuICAgIFx0dmVydGV4U2hhZGVyOiB2ZXJ0ZXhTaGFkZXIxLFxuICAgIFx0ZnJhZ21lbnRTaGFkZXI6IGZyYWdtZW50U2hhZGVyMSxcbiAgICBcdHNpZGU6IFRIUkVFLkJhY2tTaWRlXG4gICAgfSApO1xuXG4gIFx0bWF0ZXJpYWxTZWNvbmRQYXNzID0gbmV3IFRIUkVFLlNoYWRlck1hdGVyaWFsKCB7XG4gICAgXHR2ZXJ0ZXhTaGFkZXI6IHZlcnRleFNoYWRlcjIsXG4gICAgXHRmcmFnbWVudFNoYWRlcjogZnJhZ21lbnRTaGFkZXIyLFxuICBcdFx0c2lkZTogVEhSRUUuRnJvbnRTaWRlLFxuICBcdFx0dW5pZm9ybXM6IHtcbiAgICAgICAgdGV4OiAge1xuICAgICAgICAgIHR5cGU6IFwidFwiLFxuICAgICAgICAgIHZhbHVlOiBydFRleHR1cmVcbiAgICAgICAgfSxcbiAgXHRcdFx0Y3ViZVRleDpcbiAgICAgICAge1xuICAgICAgICAgIHR5cGU6IFwidFwiLFxuICAgICAgICAgIHZhbHVlOiBjdWJlVGV4dHVyZVxuICAgICAgICB9LFxuICBcdFx0XHR0cmFuc2ZlclRleDpcbiAgICAgICAge1xuICAgICAgICAgIHR5cGU6IFwidFwiLFxuICAgICAgICAgIHZhbHVlOiB0cmFuc2ZlclRleHR1cmVcbiAgICAgICAgfSxcbiAgXHRcdFx0c3RlcHMgOiB7XG4gICAgICAgICAgdHlwZTogXCIxZlwiICxcbiAgICAgICAgICB2YWx1ZTogNjRcbiAgICAgICAgfSxcbiAgXHRcdFx0YWxwaGFDb3JyZWN0aW9uIDoge1xuICAgICAgICAgIHR5cGU6IFwiMWZcIiAsXG4gICAgICAgICAgdmFsdWU6IDEuMFxuICAgICAgICB9XG4gICAgICB9XG4gIFx0IH0pO1xuXG5cbiAgICAvLyBHZW9tZXRyeSBzZXR1cFxuICBcdHZhciBib3hHZW9tZXRyeSA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSgxLjAsIDEuMCwgMS4wKTtcbiAgXHRib3hHZW9tZXRyeS5kb3VibGVTaWRlZCA9IHRydWU7XG4gIFx0dmFyIG1lc2hGaXJzdFBhc3MgPSBuZXcgVEhSRUUuTWVzaCggYm94R2VvbWV0cnksIG1hdGVyaWFsRmlyc3RQYXNzICk7XG4gIFx0dmFyIG1lc2hTZWNvbmRQYXNzID0gbmV3IFRIUkVFLk1lc2goIGJveEdlb21ldHJ5LCBtYXRlcmlhbFNlY29uZFBhc3MgKTtcbiAgXHRzY2VuZUZpcnN0UGFzcy5hZGQoIG1lc2hGaXJzdFBhc3MgKTtcbiAgXHRzY2VuZVNlY29uZFBhc3MuYWRkKCBtZXNoU2Vjb25kUGFzcyApO1xuXG5cbiAgICByZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKCk7XG4gICAgcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbyggd2luZG93LmRldmljZVBpeGVsUmF0aW8gKTtcbiAgICByZW5kZXJlci5zZXRTaXplKCBzY3JlZW5TaXplLngsIHNjcmVlblNpemUueSApO1xuICAgIHJlbmRlcmVyLmF1dG9DbGVhciA9IHRydWU7XG4gICAgcmVuZGVyZXIuc2V0Q2xlYXJDb2xvcihcIiNGRkZGRkZcIik7XG4gICAgY29uc29sZS5sb2coXCJjbGVhciBjb2xvcjogXCIpO1xuICAgIGNvbnNvbGUubG9nKHJlbmRlcmVyLmdldENsZWFyQ29sb3IoKSk7XG4gICAgcmVuZGVyZXIuZG9tRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2lkJywgJ2NhbnZhcycpO1xuICAgIGNvbnRhaW5lci5hcHBlbmQoIHJlbmRlcmVyLmRvbUVsZW1lbnQgKTtcblxuICAgIHZhciBiID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDIsMiwyKTtcbiAgICB2YXIgYm1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7Y29sb3I6IFwiI0ZGMDAwMFwifSk7XG5cbiAgICB2YXIgYm1lc2ggPSBuZXcgVEhSRUUuTWVzaChiLCBibWF0KTtcbiAgICBibWVzaC5wb3NpdGlvbi54ID0gMDtcbiAgICBibWVzaC5wb3NpdGlvbi55ID0gMDtcbiAgICBibWVzaC5wb3NpdGlvbi56ID0gMDtcblxuICAgIC8vc2NlbmVTZWNvbmRQYXNzLmFkZChibWVzaCk7XG5cbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggJ3Jlc2l6ZScsIG9uV2luZG93UmVzaXplLCBmYWxzZSApO1xuXG4gICAgYW5pbWF0ZSgpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gb25XaW5kb3dSZXNpemUoKSB7XG5cbiAgd2luZG93SGFsZlggPSBzY3JlZW5TaXplLnggLyAyO1xuICB3aW5kb3dIYWxmWSA9IHNjcmVlblNpemUueSAvIDI7XG5cbiAgY2FtZXJhLmFzcGVjdCA9IHNjcmVlblNpemUueC9zY3JlZW5TaXplLnk7XG4gIGNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7XG5cbiAgcmVuZGVyZXIuc2V0U2l6ZSggc2NyZWVuU2l6ZS54LCBzY3JlZW5TaXplLnkgKTtcblxufVxuXG5cbmZ1bmN0aW9uIGFuaW1hdGUoKSB7XG5cbiAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCBhbmltYXRlICk7XG5cbiAgcmVuZGVyKCk7XG5cbn1cblxuZnVuY3Rpb24gcmVuZGVyKCkge1xuXG4gIC8vdmFyIGRlbHRhID0gY2xvY2suZ2V0RGVsdGEoKTtcblx0Ly9SZW5kZXIgZmlyc3QgcGFzcyBhbmQgc3RvcmUgdGhlIHdvcmxkIHNwYWNlIGNvb3JkcyBvZiB0aGUgYmFjayBmYWNlIGZyYWdtZW50cyBpbnRvIHRoZSB0ZXh0dXJlLlxuXHRyZW5kZXJlci5yZW5kZXIoIHNjZW5lRmlyc3RQYXNzLCBjYW1lcmEsIHJ0VGV4dHVyZSwgdHJ1ZSApO1xuXHQvL1JlbmRlciB0aGUgc2Vjb25kIHBhc3MgYW5kIHBlcmZvcm0gdGhlIHZvbHVtZSByZW5kZXJpbmcuXG5cdHJlbmRlcmVyLnJlbmRlciggc2NlbmVTZWNvbmRQYXNzLCBjYW1lcmEgKTtcblx0bWF0ZXJpYWxTZWNvbmRQYXNzLnVuaWZvcm1zLnN0ZXBzLnZhbHVlID0gMjU2O1xuXHRtYXRlcmlhbFNlY29uZFBhc3MudW5pZm9ybXMuYWxwaGFDb3JyZWN0aW9uLnZhbHVlID0gMS4wO1xuXG59XG5cbmZ1bmN0aW9uIHVwZGF0ZVRleHR1cmVzKHZhbHVlKSB7XG4gIG1hdGVyaWFsU2Vjb25kUGFzcy51bmlmb3Jtcy50cmFuc2ZlclRleC52YWx1ZSA9IHVwZGF0ZVRyYW5zZmVyRnVuY3Rpb24oKTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlVHJhbnNmZXJGdW5jdGlvbigpIHtcblx0dmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuXHRjYW52YXMuaGVpZ2h0ID0gMjA7XG5cdGNhbnZhcy53aWR0aCA9IDI1Njtcblx0dmFyIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuXHR2YXIgZ3JkID0gY3R4LmNyZWF0ZUxpbmVhckdyYWRpZW50KDAsIDAsIGNhbnZhcy53aWR0aCAtMSAsIGNhbnZhcy5oZWlnaHQgLSAxKTtcblx0Z3JkLmFkZENvbG9yU3RvcCgwLjEsIFwiIzAwRkYwMFwiKTtcblx0Z3JkLmFkZENvbG9yU3RvcCgwLjcsIFwiI0ZGMDAwMFwiKTtcblx0Z3JkLmFkZENvbG9yU3RvcCgxLjAsIFwiIzAwMDBGRlwiKTtcblx0Y3R4LmZpbGxTdHlsZSA9IGdyZDtcblx0Y3R4LmZpbGxSZWN0KDAsMCxjYW52YXMud2lkdGggLTEgLGNhbnZhcy5oZWlnaHQgLTEgKTtcblxuICB2YXIgaW1nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ0cmFuc2ZlclRleHR1cmVcIik7XG5cdFx0XHRcdGltZy5zcmMgPSBjYW52YXMudG9EYXRhVVJMKCk7XG5cdFx0XHRcdGltZy5zdHlsZS53aWR0aCA9IFwiMjU2IHB4XCI7XG5cdFx0XHRcdGltZy5zdHlsZS5oZWlnaHQgPSBcIjIwIHB4XCI7XG5cblx0dHJhbnNmZXJUZXh0dXJlID0gIG5ldyBUSFJFRS5UZXh0dXJlKGNhbnZhcyk7XG5cdHRyYW5zZmVyVGV4dHVyZS53cmFwUyA9IHRyYW5zZmVyVGV4dHVyZS53cmFwVCA9ICBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nO1xuXHR0cmFuc2ZlclRleHR1cmUubmVlZHNVcGRhdGUgPSB0cnVlO1xuXHRyZXR1cm4gdHJhbnNmZXJUZXh0dXJlO1xufVxuXG5cbiQoZG9jdW1lbnQpLm9uKCdyZWFkeUZvckNhbnZhc1JheWNhc3RlcicsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gIGNvbnNvbGUubG9nKFwicmVhZHlGb3JDYW52YXNSYXljYXN0ZXJcIik7XG4gIGxvYWRTaGFkZXJzKCk7XG4gICQoXCIjY2FudmFzXCIpLm9uKCAnbW91c2Vtb3ZlJywgb25Eb2N1bWVudE1vdXNlTW92ZSApO1xufSk7XG5cbiQoZG9jdW1lbnQpLm9uKCdyb3RhdGlvblZhbHVlQ2hhbmdlZCcsIGZ1bmN0aW9uKGV2ZW50LCB4LCB5KSB7XG4gIGNvbnNvbGUubG9nKCdyb3RhdGlvblZhbHVlQ2hhbmdlZDogJyArIHggKyAnLCAnICsgeSk7XG4gIHJ4ID0geDtcbiAgcnkgPSB5O1xufSk7XG4iLCJcbid1c2Ugc3RyaWN0JztcblxudmFyIG1haW4gPSBhbmd1bGFyLm1vZHVsZSgnY3RNYWluJywgW10pO1xuXG5tYWluLmNvbnRyb2xsZXIoJ01haW5Db250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHtcbiAgJChkb2N1bWVudCkudHJpZ2dlcigncmVhZHlGb3JDYW52YXNSYXljYXN0ZXInKTtcbiAgJChkb2N1bWVudCkudHJpZ2dlcigncmVhZHlGb3JDYW52YXMnKTtcblxuICAvLyB2YXIgcmFuZG9tZGF0YSA9IFtdO1xuICAvLyBmb3IoIHZhciBpID0gMDsgaSA8IDEyODsgaSsrKSB7XG4gIC8vICAgcmFuZG9tZGF0YVtpXSA9IFtdO1xuICAvLyAgIGZvciggdmFyIGogPSAwOyBqIDwgMTI4OyBqKyspIHtcbiAgLy8gICAgIHJhbmRvbWRhdGFbaV1bal0gPSBbXTtcbiAgLy8gICAgIGZvciggdmFyIGsgPSAwOyBrIDwgMTI4OyBrKyspIHtcbiAgLy8gICAgICAgcmFuZG9tZGF0YVtpXVtqXS5wdXNoKE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSo0MDk1KSk7XG4gIC8vICAgICB9XG4gIC8vICAgfVxuICAvLyAgIGNvbnNvbGUubG9nKFwicmFuZG9tIGRhdGEgcHJvZ3Jlc3M6IFwiICsgaS8xMjgpICsgXCIgJVwiO1xuICAvLyB9XG4vLyAgY29uc29sZS5sb2coXCJIZWxsbyBtb3NhaWNcIik7XG4vLyAgJChcIiN0ZXN0XCIpLmFwcGVuZChtb3NhaWMuY3JlYXRlTW9zYWljSW1hZ2UoMTI4LCAxMjgsIHJhbmRvbWRhdGEpKTtcbn1dKTtcbiIsInZhciBtb3NhaWMgPSB7fTtcblxubW9zYWljLmNyZWF0ZU9uZUltYWdlID0gZnVuY3Rpb24oc2l6ZXgsIHNpemV5LCBkYXRhKSB7XG5cdHZhciBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpO1xuXHRjYW52YXMuc2V0QXR0cmlidXRlKFwid2lkdGhcIiwgc2l6ZXgpO1xuXHRjYW52YXMuc2V0QXR0cmlidXRlKFwiaGVpZ2h0XCIsIHNpemV5KTtcblx0dmFyIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuXG5cdGZvcih2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG5cdFx0Zm9yKHZhciBqID0gMDsgaiA8IGRhdGFbMF0ubGVuZ3RoOyBqKyspIHtcblx0XHRcdHZhciBpZCA9IGN0eC5jcmVhdGVJbWFnZURhdGEoMSwxKTtcblx0XHRcdHZhciBtc2IgPSBkYXRhW2ldW2pdICYgMHhGRjAwO1xuXHRcdFx0bXNiID0gbXNiID4+IDg7XG5cdFx0XHR2YXIgbHNiID0gZGF0YVtpXVtqXSAmIDB4MDBGRjtcblx0XHRcdC8vIFVzZSBiaXRtYXNrIGZvciBzcGxpdGluZyB0aGUgdWludDE2IHZhbHVlIGludG8gdHdvIHVpbnQ4IHRvIGZpdCBpbnRvIGltZ1xuXHRcdFx0aWQuZGF0YVswXSA9IG1zYjtcdC8vIHJcblx0XHRcdGlkLmRhdGFbMV0gPSBsc2I7XHQvLyBnXG5cdFx0XHRpZC5kYXRhWzJdID0gMDtcdC8vIGJcblx0XHRcdGlkLmRhdGFbM10gPSAyNTU7Ly9NYXRoLmZsb29yKGRhdGFbaV1bal0vNDA5NSoyNTUpO1x0Ly8gYVxuXHRcdFx0Y3R4LnB1dEltYWdlRGF0YShpZCwgaiwgaSk7IC8vIHJvdyBiYXNlZCwgc28gYWRkIHRvIHg9aiwgeT1pXG5cdFx0XHQvL2NvbnNvbGUubG9nKFwiY2FsYzogXCIgKyAoaWQuZGF0YVswXSoyNTUuMCoyNTYuMCArIGlkLmRhdGFbMV0qMjU1LjApLzQwOTYuMC8yNTUuMCk7XG5cdFx0fVxuXHR9XG5cblx0dmFyIGltYWdlID0gbmV3IEltYWdlKCk7XG5cdGltYWdlLnNyYyA9IGNhbnZhcy50b0RhdGFVUkwoXCIvaW1hZ2UvcG5nXCIpO1xuXHRyZXR1cm4gaW1hZ2U7XG59XG5cbm1vc2FpYy5jcmVhdGVNb3NhaWNJbWFnZSA9IGZ1bmN0aW9uKHNpemV4LCBzaXpleSwgZGF0YSwgY2FsbGJhY2spIHtcblx0dmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYW52YXNcIik7XG5cdGNhbnZhcy5zZXRBdHRyaWJ1dGUoXCJ3aWR0aFwiLCBzaXpleCo4KTtcblx0Y2FudmFzLnNldEF0dHJpYnV0ZShcImhlaWdodFwiLCBzaXpleSo4KTtcblx0dmFyIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuXG5cdGZvcih2YXIgaSA9IDA7IGkgPCA4OyBpKyspIHtcblx0XHRmb3IodmFyIGogPSAwOyBqIDwgODsgaisrKSB7XG5cdFx0XHR2YXIgaW1hZ2UgPSB0aGlzLmNyZWF0ZU9uZUltYWdlKHNpemV4LCBzaXpleSwgZGF0YVtpKmoral0pO1xuXHRcdFx0Y3R4LmRyYXdJbWFnZShpbWFnZSwgc2l6ZXgqaSwgc2l6ZXkqaiwgc2l6ZXgsIHNpemV5KTtcblx0XHRcdGNvbnNvbGUubG9nKFwiaW1hZ2UgZ2VuZXJhdGlvbiBwcm9ncmVzczogXCIgKyBNYXRoLmZsb29yKChpKmoraikvZGF0YS5sZW5ndGgqMTAwKSArIFwiICVcIik7XG5cdFx0fVxuXHR9XG4vL1x0dmFyIGltZyA9IG5ldyBJbWFnZSgpO1xuXHQvL2ltZy5zcmMgPSBjYW52YXMudG9EYXRhVVJMKFwiL2ltYWdlL3BuZ1wiKTtcblx0Y2FsbGJhY2soY2FudmFzKTtcbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
